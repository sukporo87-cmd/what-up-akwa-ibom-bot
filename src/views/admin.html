<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>What's Up Trivia - Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>
  <style>
    /* BATCH 1/10 - CSS Variables and Base Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #667eea;
      --primary-dark: #5568d3;
      --success: #10b981;
      --success-dark: #059669;
      --danger: #ef4444;
      --danger-dark: #dc2626;
      --warning: #f59e0b;
      --secondary: #6b7280;
      --bg-gray: #f5f7fa;
      --text-dark: #333;
      --text-gray: #666;
      --text-light: #999;
      --border: #e0e0e0;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-lg: 0 4px 12px rgba(0,0,0,0.12);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-gray);
      color: var(--text-dark);
      line-height: 1.6;
    }

    /* Login Page Styles */
    #loginPage {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
      padding: 20px;
    }

    .login-container {
      background: white;
      border-radius: 20px;
      padding: 50px 40px;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }

    .login-logo { font-size: 64px; margin-bottom: 20px; }
    .login-container h1 { font-size: 28px; color: var(--text-dark); margin-bottom: 10px; }
    .login-container p { color: var(--text-gray); margin-bottom: 30px; }
    .login-form { text-align: left; }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .login-btn:hover { background: var(--primary-dark); }
    .login-btn:disabled { background: var(--secondary); cursor: not-allowed; }

    .login-error {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .login-error.show { display: block; animation: shake 0.3s; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: #666;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab-btn:hover { color: var(--primary); }
    .tab-btn.active {
      border-bottom-color: var(--primary);
      color: var(--primary);
      font-weight: 600;
    }

    /* Dashboard Styles */
    #dashboardPage { display: none; }
    #dashboardPage.active { display: block; }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
      color: white;
      padding: 20px 40px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left h1 { font-size: 24px; margin-bottom: 5px; }
    .header-left p { opacity: 0.9; font-size: 14px; }

    .header-right { display: flex; gap: 15px; align-items: center; }
    .admin-info { text-align: right; margin-right: 20px; }
    .admin-info .admin-name { font-weight: 600; font-size: 14px; }
    .admin-info .session-timer { font-size: 12px; opacity: 0.8; }

    .logout-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logout-btn:hover { background: white; color: var(--primary); }

    .container { max-width: 1600px; margin: 0 auto; padding: 30px 20px; }

    /* BATCH 1/10 COMPLETE - Base styles and login page */

    /* BATCH 2/10 - Stats Cards and Component Styles */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--primary);
      transform: scaleY(0);
      transition: transform 0.3s;
    }

    .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
    .stat-card:hover::before { transform: scaleY(1); }

    .stat-card h3 {
      font-size: 13px;
      color: var(--text-gray);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value { font-size: 32px; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
    .stat-card .label { font-size: 13px; color: var(--text-light); }

    .stat-card.gradient { color: white; }
    .stat-card.gradient h3 { color: rgba(255,255,255,0.9); }
    .stat-card.gradient .value { color: white; }
    .stat-card.gradient .label { color: rgba(255,255,255,0.8); }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 15px;
      color: var(--text-gray);
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab:hover { color: var(--primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }

    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card { background: white; border-radius: 12px; padding: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
      flex-wrap: wrap;
      gap: 15px;
    }

    .card-header h2 { font-size: 20px; color: var(--text-dark); }
    .card-header h3 { font-size: 18px; color: var(--text-dark); margin-bottom: 15px; }

    .filter-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .filter-group select, .filter-group input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    .filter-group select:focus, .filter-group input:focus { outline: none; border-color: var(--primary); }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover:not(:disabled) { background: var(--success-dark); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover:not(:disabled) { background: var(--danger-dark); }
    .btn-secondary { background: var(--secondary); color: white; }
    .btn-secondary:hover:not(:disabled) { background: #4b5563; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-warning:hover:not(:disabled) { background: #d97706; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }

    /* BATCH 2/10 COMPLETE - Stats cards and buttons */

    /* BATCH 3/10 - Tables, Badges, and Modals */
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead { background: #f9fafb; }
    th {
      text-align: left;
      padding: 12px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border);
    }
    td { padding: 15px 12px; border-bottom: 1px solid #f0f0f0; }
    tr:hover { background: #f9fafb; }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-details_collected { background: #dbeafe; color: #1e40af; }
    .status-approved { background: #d1fae5; color: #065f46; }
    .status-paid { background: #d1fae5; color: #065f46; }
    .status-confirmed { background: #e0e7ff; color: #3730a3; }
    .status-upcoming { background: #dbeafe; color: #1e40af; }
    .status-active { background: #d1fae5; color: #065f46; }
    .status-completed { background: #e5e7eb; color: #374151; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }

    .verified-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: #d1fae5;
      color: #065f46;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .unverified-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: #fee2e2;
      color: #991b1b;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .empty-state .icon { font-size: 64px; opacity: 0.3; margin-bottom: 15px; }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .modal.show { display: flex; animation: fadeIn 0.2s; }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.3s;
    }
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    .modal-header h3 { font-size: 20px; }
    .close-modal {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--text-light);
      transition: color 0.3s, transform 0.3s;
    }
    .close-modal:hover { color: var(--danger); transform: rotate(90deg); }

    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #555;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }
    .form-group textarea { resize: vertical; min-height: 80px; font-family: inherit; }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { font-weight: 500; color: var(--text-gray); }
    .detail-value { color: var(--text-dark); font-weight: 500; }

    /* BATCH 3/10 COMPLETE - Tables, badges, and modals */

    /* BATCH 4/10 - Loading, Alerts, Charts, and Metrics */
    .loading { text-align: center; padding: 40px; color: var(--text-light); }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      animation: slideDown 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .alert-success { background: #d1fae5; color: #065f46; border: 1px solid var(--success); }
    .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid var(--danger); }
    .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }

    .chart-container { position: relative; height: 300px; margin: 20px 0; }
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .top-performers-table { width: 100%; margin-top: 20px; }
    .top-performers-table td { padding: 12px; }
    .medal { font-size: 24px; margin-right: 8px; }

    .metric-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .metric-icon {
      font-size: 48px;
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: rgba(102, 126, 234, 0.1);
    }
    .metric-info h4 {
      font-size: 14px;
      color: var(--text-gray);
      margin-bottom: 5px;
    }
    .metric-info .metric-value {
      font-size: 28px;
      font-weight: bold;
      color: var(--text-dark);
    }
    .metric-info .metric-change { font-size: 13px; margin-top: 5px; }
    .metric-change.positive { color: var(--success); }
    .metric-change.negative { color: var(--danger); }

    @media (max-width: 768px) {
      .header { padding: 15px 20px; flex-direction: column; gap: 15px; }
      .header-right { width: 100%; justify-content: space-between; }
      .container { padding: 20px 15px; }
      .stats-grid { grid-template-columns: 1fr; }
      .card-header { flex-direction: column; align-items: flex-start; }
      .filter-group { width: 100%; }
      table { font-size: 12px; }
      th, td { padding: 8px; }
      .btn { padding: 8px 16px; font-size: 13px; }
      .chart-grid { grid-template-columns: 1fr; }
    }

    /* BATCH 4/10 COMPLETE - All CSS complete */
  </style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <div class="login-container">
    <div class="login-logo">üéÆ</div>
    <h1>Admin Dashboard</h1>
    <p>What's Up Trivia - Akwa Ibom Edition</p>
    <div class="login-error" id="loginError"></div>
    
    <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
      <button type="button" class="tab-btn active" id="tokenTab" onclick="switchLoginTab('token')">Token Login</button>
      <button type="button" class="tab-btn" id="usernameTab" onclick="switchLoginTab('username')">Username/Password</button>
    </div>

    <form class="login-form" id="tokenLoginForm" style="display: block;">
      <div class="form-group">
        <label>Admin Access Token</label>
        <input type="password" id="adminToken" placeholder="Enter admin token" required autofocus>
      </div>
      <button type="submit" class="login-btn" id="tokenLoginBtn">üîê Sign In</button>
    </form>

    <form class="login-form" id="usernameLoginForm" style="display: none;">
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="adminUsername" placeholder="Enter username" required>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="adminPassword" placeholder="Enter password" required>
      </div>
      <button type="submit" class="login-btn" id="usernameLoginBtn">üîê Sign In</button>
    </form>

    <p style="margin-top: 20px; font-size: 12px; color: #999;">Secure access only ‚Ä¢ All activity is logged</p>
  </div>
</div>

<!-- BATCH 4/10 COMPLETE - CSS and Login HTML -->

<!-- BATCH 5/10 - Dashboard Header and Stats Grid -->
<!-- MAIN DASHBOARD -->
<div id="dashboardPage">
  <div class="header">
    <div class="header-left">
      <h1>üéÆ What's Up Trivia - Admin Dashboard</h1>
      <p>Akwa Ibom Edition</p>
    </div>
    <div class="header-right">
      <div class="admin-info">
        <div class="admin-name" id="adminDisplayName">üë§ Admin</div>
        <div class="session-timer" id="sessionTimer">Session active</div>
      </div>
      <!-- Navigation Links -->
      <div class="nav-links" style="display: flex; gap: 10px; align-items: center;">
        <a href="/admin/financials" class="nav-link" style="
            padding: 10px 16px;
            background: linear-gradient(135deg, #0f766e 0%, #0d5d56 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s, box-shadow 0.2s;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(15,118,110,0.4)';" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            üí∞ Financials
        </a>
        <a href="/admin/dashboard" class="nav-link" style="
            padding: 10px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s, box-shadow 0.2s;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.4)';" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            üìä Analytics
        </a>
        <a href="/admin/audit" class="nav-link" style="
            padding: 10px 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s, box-shadow 0.2s;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.4)';" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            üìù Audit Trail
        </a>
      </div>
      <button class="logout-btn" onclick="logout()">
        <span>üö™</span>
        <span>Logout</span>
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Basic Stats -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3>Pending Payouts</h3>
        <div class="value" id="pendingCount">-</div>
        <div class="label" id="pendingAmount">Loading...</div>
      </div>
      <div class="stat-card">
        <h3>Paid Today</h3>
        <div class="value" id="paidCount">-</div>
        <div class="label" id="paidAmount">Loading...</div>
      </div>
      <div class="stat-card">
        <h3>Total Users</h3>
        <div class="value" id="totalUsers">-</div>
        <div class="label">Registered players</div>
      </div>
      <div class="stat-card">
        <h3>Total Questions</h3>
        <div class="value" id="totalQuestions">-</div>
        <div class="label">Active questions</div>
      </div>
    </div>

    <!-- Games Count Stats -->
    <div class="stats-grid">
      <div class="stat-card gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h3>Today</h3>
        <div class="value" id="gamesToday">-</div>
        <div class="label">Games played today</div>
      </div>
      <div class="stat-card gradient" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
        <h3>This Week</h3>
        <div class="value" id="gamesWeek">-</div>
        <div class="label">Games this week</div>
      </div>
      <div class="stat-card gradient" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
        <h3>This Month</h3>
        <div class="value" id="gamesMonth">-</div>
        <div class="label">Games this month</div>
      </div>
      <div class="stat-card gradient" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
        <h3>This Quarter</h3>
        <div class="value" id="gamesQuarter">-</div>
        <div class="label">Games this quarter</div>
      </div>
      <div class="stat-card gradient" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
        <h3>This Year</h3>
        <div class="value" id="gamesYear">-</div>
        <div class="label">Games this year</div>
      </div>
      <div class="stat-card gradient" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
        <h3>All Time</h3>
        <div class="value" id="gamesAllTime">-</div>
        <div class="label">Total games played</div>
      </div>
    </div>

    <!-- User Activity Metrics -->
    <div class="stats-grid">
      <div class="metric-card">
        <div class="metric-icon">üë•</div>
        <div class="metric-info">
          <h4>Daily Active Users</h4>
          <div class="metric-value" id="dailyActiveUsers">-</div>
          <div class="metric-change positive" id="dauChange">-</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">üîÑ</div>
        <div class="metric-info">
          <h4>User Retention (7-Day)</h4>
          <div class="metric-value" id="userRetention">-</div>
          <div class="metric-change" id="retentionChange">-</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">üìä</div>
        <div class="metric-info">
          <h4>Conversion Rate</h4>
          <div class="metric-value" id="conversionRate">-</div>
          <div class="metric-change" id="conversionChange">-</div>
        </div>
      </div>
    </div>

    <div id="alertContainer"></div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('analytics')">üìä Analytics</button>
      <button class="tab" onclick="switchTab('payouts')">üí∞ Payouts</button>
      <button class="tab" onclick="switchTab('history')">üìú History</button>
      <button class="tab" onclick="switchTab('users')">üë• Users</button>
      <button class="tab" onclick="switchTab('restrictions')">üö´ Restrictions</button>
      <button class="tab" onclick="switchTab('fraud')">üîç Fraud</button>
      <button class="tab" onclick="switchTab('security')">üîê Security</button>
      <button class="tab" onclick="switchTab('winners')">üèÜ Winners</button>
      <button class="tab" onclick="switchTab('questions')">‚ùì Questions</button>
      <button class="tab" onclick="switchTab('tournaments')">üèÖ Tournaments</button>
      <button class="tab" onclick="switchTab('activity')">üìã Activity Log</button>
    </div>

<!-- BATCH 5/10 COMPLETE - Dashboard header and stats -->

<!-- BATCH 6/10 - Tab Contents (Analytics, Payouts, History, Users) -->
    <!-- Analytics Tab -->
    <div id="analyticsTab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2>üìä Advanced Analytics Dashboard</h2>
          <button class="btn btn-primary" onclick="loadAnalytics()">üîÑ Refresh</button>
        </div>
        <div id="analyticsContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading analytics...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Payouts Tab -->
    <div id="payoutsTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Pending Payouts</h2>
          <div class="filter-group">
            <select id="statusFilter" onchange="filterPayouts()">
              <option value="">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="details_collected">Details Collected</option>
              <option value="approved">Approved</option>
              <option value="paid">Paid</option>
              <option value="confirmed">Confirmed</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <button class="btn btn-primary" onclick="loadPayouts()">üîÑ Refresh</button>
          </div>
        </div>
        <div id="payoutsTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading payouts...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div id="historyTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Payout History</h2>
          <div class="filter-group">
            <select id="periodFilter" onchange="loadHistory()">
              <option value="all">All Time</option>
              <option value="daily">Today</option>
              <option value="weekly">This Week</option>
              <option value="monthly">This Month</option>
            </select>
            <button class="btn btn-primary" onclick="loadHistory()">üîÑ Refresh</button>
          </div>
        </div>
        <div id="historyTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading history...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="usersTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>üë• All Users</h2>
          <div class="filter-group">
            <input type="text" id="userSearchQuery" placeholder="Search by name, username, phone..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 250px;">
            <select id="userPlatformFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
              <option value="">All Platforms</option>
              <option value="whatsapp">WhatsApp</option>
              <option value="telegram">Telegram</option>
            </select>
            <select id="userStatusFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
              <option value="">All Statuses</option>
              <option value="active">Active</option>
              <option value="suspended">Suspended</option>
            </select>
            <button class="btn btn-primary" onclick="searchUsers()">üîç Search</button>
            <button class="btn btn-secondary" onclick="loadUsers()">üîÑ Reset</button>
          </div>
        </div>
        <div id="usersTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading users...</p>
          </div>
        </div>
        <!-- Pagination -->
        <div id="usersPagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;"></div>
      </div>
    </div>

    <!-- Restrictions Tab (NEW) -->
    <div id="restrictionsTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>üö´ User Restrictions</h2>
          <button class="btn btn-primary" onclick="loadRestrictions()">üîÑ Refresh</button>
        </div>
        
        <!-- Sub-tabs for restrictions -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px;">
          <button class="btn btn-secondary" onclick="showRestrictionsSubTab('suspended')" id="suspendedSubTab" style="background: var(--danger);">‚õî Suspended Users</button>
          <button class="btn btn-secondary" onclick="showRestrictionsSubTab('cooldown')" id="cooldownSubTab">üèÜ Grand Prize Cooldown</button>
          <button class="btn btn-secondary" onclick="showRestrictionsSubTab('dailylimit')" id="dailylimitSubTab">üí∞ Daily Limit Reached</button>
        </div>
        
        <!-- Suspended Users Section -->
        <div id="suspendedUsersSection">
          <h3 style="margin-bottom: 15px;">‚õî Suspended Users</h3>
          <div id="suspendedUsersTable">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading suspended users...</p>
            </div>
          </div>
        </div>
        
        <!-- Cooldown Users Section -->
        <div id="cooldownUsersSection" style="display: none;">
          <h3 style="margin-bottom: 15px;">üèÜ Users on Grand Prize Cooldown</h3>
          <p style="color: var(--text-gray); margin-bottom: 15px;">These users have won the grand prize and must wait before playing Classic/Tournament mode again.</p>
          <div id="cooldownUsersTable">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading cooldown users...</p>
            </div>
          </div>
        </div>
        
        <!-- Daily Limit Section -->
        <div id="dailyLimitSection" style="display: none;">
          <h3 style="margin-bottom: 15px;">üí∞ Users at Daily Win Limit</h3>
          <p style="color: var(--text-gray); margin-bottom: 15px;">These users have reached the daily win limit of ‚Ç¶30,000 and cannot play Classic/Tournament mode until tomorrow.</p>
          <div id="dailyLimitUsersTable">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading daily limit users...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Fraud Monitoring Tab (NEW) -->
    <div id="fraudTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>üîç Fraud Monitoring</h2>
          <button class="btn btn-primary" onclick="loadFraudData()">üîÑ Refresh</button>
        </div>
        
        <!-- Fraud Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
          <div class="stat-card" style="background: #fee2e2;">
            <h3 style="color: #991b1b;">Flagged Users</h3>
            <div class="value" id="flaggedUsersCount" style="color: #dc2626;">-</div>
          </div>
          <div class="stat-card" style="background: #fef3c7;">
            <h3 style="color: #92400e;">Suspicious Sessions</h3>
            <div class="value" id="suspiciousSessionsCount" style="color: #d97706;">-</div>
          </div>
          <div class="stat-card" style="background: #fef9c3;">
            <h3 style="color: #854d0e;">‚ö° Turbo Triggers</h3>
            <div class="value" id="turboTriggersCount" style="color: #ca8a04;">-</div>
          </div>
          <div class="stat-card" style="background: #fecaca;">
            <h3 style="color: #991b1b;">‚ö° Turbo Timeouts</h3>
            <div class="value" id="turboTimeoutsCount" style="color: #dc2626;">-</div>
          </div>
        </div>
        
        <!-- Sub-tabs -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px;">
          <button class="btn btn-danger" onclick="showFraudSubTab('flagged')" id="flaggedSubTab">üö© Flagged Users</button>
          <button class="btn btn-secondary" onclick="showFraudSubTab('sessions')" id="sessionsSubTab">‚ö†Ô∏è Suspicious Sessions</button>
          <button class="btn btn-warning" onclick="showFraudSubTab('turbo')" id="turboSubTab">‚ö° Turbo Mode Events</button>
        </div>
        
        <!-- Flagged Users -->
        <div id="flaggedUsersSection">
          <h3 style="margin-bottom: 15px;">üö© Flagged Users</h3>
          <p style="color: var(--text-gray); margin-bottom: 15px;">Users flagged for unusually fast response times or suspicious patterns.</p>
          <div id="flaggedUsersTable">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading flagged users...</p>
            </div>
          </div>
        </div>
        
        <!-- Suspicious Sessions -->
        <div id="suspiciousSessionsSection" style="display: none;">
          <h3 style="margin-bottom: 15px;">‚ö†Ô∏è Suspicious Game Sessions</h3>
          <div id="suspiciousSessionsTable">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading suspicious sessions...</p>
            </div>
          </div>
        </div>
        
        <!-- Turbo Mode Events -->
        <div id="turboModeSection" style="display: none;">
          <h3 style="margin-bottom: 15px;">‚ö° Turbo Mode Events</h3>
          <p style="color: var(--text-gray); margin-bottom: 15px;">Players who triggered turbo mode by answering 3 consecutive questions in 10.5s-11.99s window.</p>
          <div id="turboModeTable">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading turbo mode events...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Security Tab (NEW) -->
    <div id="securityTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>üîê Security Center</h2>
          <button class="btn btn-primary" onclick="loadSecurityDashboard()">üîÑ Refresh</button>
        </div>
        
        <!-- Security Stats Overview -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
          <div class="stat-card" style="background: #fef3c7;">
            <h3 style="color: #92400e;">üìã Pending KYC</h3>
            <div class="value" id="pendingKycCount" style="color: #d97706;">-</div>
          </div>
          <div class="stat-card" style="background: #fee2e2;">
            <h3 style="color: #991b1b;">üö® Fraud Alerts</h3>
            <div class="value" id="fraudAlertsCount" style="color: #dc2626;">-</div>
          </div>
          <div class="stat-card" style="background: #fce7f3;">
            <h3 style="color: #9d174d;">‚ö†Ô∏è Critical</h3>
            <div class="value" id="criticalAlertsCount" style="color: #be185d;">-</div>
          </div>
          <div class="stat-card" style="background: #dbeafe;">
            <h3 style="color: #1e40af;">üîó Account Links</h3>
            <div class="value" id="accountLinksCount" style="color: #2563eb;">-</div>
          </div>
          <div class="stat-card" style="background: #f3e8ff;">
            <h3 style="color: #6b21a8;">üë§ High Risk</h3>
            <div class="value" id="highRiskCount" style="color: #7c3aed;">-</div>
          </div>
          <div class="stat-card" style="background: #ecfdf5;">
            <h3 style="color: #065f46;">ü§ñ CAPTCHA Fail</h3>
            <div class="value" id="captchaFailRate" style="color: #059669;">-</div>
          </div>
        </div>
        
        <!-- Sub-tabs -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; flex-wrap: wrap;">
          <button class="btn btn-warning" onclick="showSecuritySubTab('kyc')" id="kycSubTab" style="background: var(--warning);">üìã KYC Review</button>
          <button class="btn btn-secondary" onclick="showSecuritySubTab('alerts')" id="alertsSubTab">üö® Fraud Alerts</button>
          <button class="btn btn-secondary" onclick="showSecuritySubTab('devices')" id="devicesSubTab">üì± Devices</button>
          <button class="btn btn-secondary" onclick="showSecuritySubTab('behavior')" id="behaviorSubTab">üìä Behavior</button>
          <button class="btn btn-secondary" onclick="showSecuritySubTab('captcha')" id="captchaSubTab">ü§ñ CAPTCHA</button>
        </div>
        
        <!-- KYC Section -->
        <div id="kycSection">
          <h3 style="margin-bottom: 15px;">üìã KYC Verification Queue</h3>
          <p style="color: var(--text-gray); margin-bottom: 15px;">Users who need identity verification (daily winnings ‚â• ‚Ç¶20,000)</p>
          <div id="kycTable">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading KYC submissions...</p>
            </div>
          </div>
        </div>
        
        <!-- Fraud Alerts Section -->
        <div id="alertsSection" style="display: none;">
          <h3 style="margin-bottom: 15px;">üö® Fraud Alerts</h3>
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="btn btn-sm btn-danger" onclick="loadFraudAlerts('new')">New</button>
            <button class="btn btn-sm btn-warning" onclick="loadFraudAlerts('investigating')">Investigating</button>
            <button class="btn btn-sm btn-success" onclick="loadFraudAlerts('resolved')">Resolved</button>
          </div>
          <div id="alertsTable">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading fraud alerts...</p>
            </div>
          </div>
        </div>
        
        <!-- Devices Section -->
        <div id="devicesSection" style="display: none;">
          <h3 style="margin-bottom: 15px;">üì± Device & Account Links</h3>
          <p style="color: var(--text-gray); margin-bottom: 15px;">Detected multi-account usage based on device fingerprints and IP addresses</p>
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="btn btn-sm btn-primary" onclick="loadSharedDevices()">üîÑ Shared Devices</button>
          </div>
          <div id="devicesTable">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading device data...</p>
            </div>
          </div>
        </div>
        
        <!-- Behavior Section -->
        <div id="behaviorSection" style="display: none;">
          <h3 style="margin-bottom: 15px;">üìä Behavioral Analysis</h3>
          <p style="color: var(--text-gray); margin-bottom: 15px;">Users with suspicious play patterns</p>
          <div style="margin-bottom: 15px;">
            <label>Minimum Anomaly Score: </label>
            <select id="anomalyScoreFilter" onchange="loadHighRiskUsers()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
              <option value="50">50+</option>
              <option value="60">60+</option>
              <option value="70" selected>70+ (High Risk)</option>
              <option value="80">80+ (Critical)</option>
            </select>
          </div>
          <div id="behaviorTable">
            <div class="loading">
              <div class="spinner"></div>
              <p>Loading behavioral data...</p>
            </div>
          </div>
        </div>
        
        <!-- CAPTCHA Section -->
        <div id="captchaSection" style="display: none;">
          <h3 style="margin-bottom: 15px;">ü§ñ CAPTCHA Statistics</h3>
          <p style="color: var(--text-gray); margin-bottom: 15px;">CAPTCHA performance over the last 7 days</p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="stat-card">
              <h3>Total CAPTCHAs</h3>
              <div class="value" id="totalCaptchas">-</div>
            </div>
            <div class="stat-card" style="background: #dcfce7;">
              <h3 style="color: #166534;">Passed</h3>
              <div class="value" id="passedCaptchas" style="color: #16a34a;">-</div>
            </div>
            <div class="stat-card" style="background: #fee2e2;">
              <h3 style="color: #991b1b;">Failed</h3>
              <div class="value" id="failedCaptchas" style="color: #dc2626;">-</div>
            </div>
          </div>
          <h4 style="margin: 20px 0 10px;">By Type</h4>
          <div id="captchaByType"><p style="color: var(--text-gray);">Click refresh to load...</p></div>
          <h4 style="margin: 20px 0 10px;">Suspicious Users</h4>
          <div id="suspiciousCaptchaUsers"><p style="color: var(--text-gray);">Click refresh to load...</p></div>
        </div>
      </div>
    </div>

    <!-- Winners Tab (NEW) -->
    <div id="winnersTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>üèÜ Recent Winners & Victory Cards</h2>
          <button class="btn btn-primary" onclick="loadWinners()">üîÑ Refresh</button>
        </div>
        
        <!-- Win Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
          <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
            <h3>Today's Wins</h3>
            <div class="value" id="todayWinsCount">-</div>
            <div class="label" id="todayWinsAmount">‚Ç¶0</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
            <h3>Cards Shared</h3>
            <div class="value" id="cardsSharedCount">-</div>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
            <h3>Cards Pending</h3>
            <div class="value" id="cardsPendingCount">-</div>
          </div>
        </div>
        
        <!-- Search and Filters -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
          <div style="flex: 1; min-width: 250px;">
            <input type="text" id="winnersSearch" placeholder="üîç Search by username, name, or phone..." 
                   style="width: 100%; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);"
                   onkeyup="handleWinnersSearch(event)">
          </div>
          <select id="winnersStatusFilter" onchange="loadWinners()" style="padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
            <option value="">All Statuses</option>
            <option value="shared">Shared</option>
            <option value="pending">Pending</option>
          </select>
          <select id="winnersModeFilter" onchange="loadWinners()" style="padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
            <option value="">All Modes</option>
            <option value="classic">Classic</option>
            <option value="tournament">Tournament</option>
          </select>
          <select id="winnersAmountFilter" onchange="loadWinners()" style="padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary);">
            <option value="">All Amounts</option>
            <option value="1000">‚Ç¶1,000+</option>
            <option value="5000">‚Ç¶5,000+</option>
            <option value="10000">‚Ç¶10,000+</option>
            <option value="20000">‚Ç¶20,000+</option>
            <option value="50000">‚Ç¶50,000 (Grand Prize)</option>
          </select>
        </div>
        
        <h3 style="margin-bottom: 15px;">Winners List <span id="winnersCountLabel" style="font-weight: normal; color: var(--text-gray);"></span></h3>
        <div id="winnersTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading winners...</p>
          </div>
        </div>
        
        <!-- Pagination -->
        <div id="winnersPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">
          <!-- Pagination will be rendered here -->
        </div>
      </div>
    </div>

    <!-- Questions Tab -->
    <div id="questionsTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Questions Bank</h2>
          <div class="filter-group">
            <select id="difficultyFilter" onchange="loadQuestions()">
              <option value="">All Difficulties</option>
              <option value="1-5">Easy (1-5)</option>
              <option value="6-10">Medium (6-10)</option>
              <option value="11-15">Hard (11-15)</option>
            </select>
            <button class="btn btn-success" onclick="showAddQuestionModal()">+ Add Question</button>
          </div>
        </div>
        <div id="questionsTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading questions...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Tournaments Tab -->
    <div id="tournamentsTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Tournament Management</h2>
          <div class="filter-group">
            <select id="tournamentStatusFilter" onchange="loadTournaments()">
              <option value="">All Statuses</option>
              <option value="upcoming">Upcoming</option>
              <option value="active">Active</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <button class="btn btn-success" onclick="showCreateTournamentModal()">+ Create Tournament</button>
            <button class="btn btn-primary" onclick="loadTournaments()">üîÑ Refresh</button>
          </div>
        </div>
        <div id="tournamentsTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading tournaments...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity Log Tab -->
    <div id="activityTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Admin Activity Log</h2>
          <div class="filter-group">
            <button class="btn btn-primary" onclick="loadActivityLog()">üîÑ Refresh</button>
          </div>
        </div>
        <div id="activityTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading activity log...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BATCH 6/10 COMPLETE - All tab contents -->

<!-- BATCH 7/10 - Modals (Mark Paid, Add Question, Tournament) -->
<!-- Mark as Paid Modal -->
<div id="markPaidModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üíµ Mark as Paid</h3>
      <button class="close-modal" onclick="closeModal('markPaidModal')">&times;</button>
    </div>
    <div id="payoutDetails"></div>
    <form id="markPaidForm" onsubmit="submitMarkPaid(event)">
      <div class="form-group">
        <label>Payment Reference *</label>
        <input type="text" id="paymentReference" required placeholder="e.g., GTB/20241208/12345">
      </div>
      <div class="form-group">
        <label>Payment Method</label>
        <select id="paymentMethod">
          <option value="bank_transfer">Bank Transfer</option>
          <option value="mobile_money">Mobile Money</option>
          <option value="ussd">USSD</option>
          <option value="other">Other</option>
        </select>
      </div>
      <input type="hidden" id="selectedTransactionId">
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button type="submit" class="btn btn-success" style="flex: 1;">‚úì Confirm Payment</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('markPaidModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Question Modal -->
<div id="addQuestionModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚ûï Add New Question</h3>
      <button class="close-modal" onclick="closeModal('addQuestionModal')">&times;</button>
    </div>
    <form id="addQuestionForm" onsubmit="submitAddQuestion(event)">
      <div class="form-group">
        <label>Question Text *</label>
        <textarea id="questionText" required placeholder="What is the capital of Akwa Ibom State?"></textarea>
      </div>
      <div class="form-group">
        <label>Option A *</label>
        <input type="text" id="optionA" required placeholder="First option">
      </div>
      <div class="form-group">
        <label>Option B *</label>
        <input type="text" id="optionB" required placeholder="Second option">
      </div>
      <div class="form-group">
        <label>Option C *</label>
        <input type="text" id="optionC" required placeholder="Third option">
      </div>
      <div class="form-group">
        <label>Option D *</label>
        <input type="text" id="optionD" required placeholder="Fourth option">
      </div>
      <div class="form-group">
        <label>Correct Answer *</label>
        <select id="correctAnswer" required>
          <option value="">Select correct answer</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select>
      </div>
      <div class="form-group">
        <label>Difficulty Level (1-15) *</label>
        <input type="number" id="difficulty" required min="1" max="15" placeholder="1 = Easiest, 15 = Hardest">
      </div>
      <div class="form-group">
        <label>Category</label>
        <input type="text" id="category" placeholder="e.g., History, Geography, Culture">
      </div>
      <div class="form-group">
        <label>Fun Fact (Optional)</label>
        <textarea id="funFact" placeholder="Interesting fact related to the answer"></textarea>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button type="submit" class="btn btn-success" style="flex: 1;">‚úì Add Question</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('addQuestionModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Tournament Modal -->
<div id="tournamentModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h3 id="tournamentModalTitle">Create Tournament</h3>
      <button class="close-modal" onclick="closeModal('tournamentModal')">&times;</button>
    </div>
    <form id="tournamentForm" onsubmit="submitTournament(event)">
      <input type="hidden" id="tournamentId">
      
      <h4 style="margin: 20px 0 10px 0; color: #667eea;">Basic Information</h4>
      
      <div class="form-group">
        <label>Tournament Name *</label>
        <input type="text" id="tournamentName" required placeholder="e.g., MTN Mega Quiz">
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="form-group">
          <label>Tournament Type</label>
          <select id="tournamentType">
            <option value="sponsored">Sponsored</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
            <option value="special">Special Event</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Status</label>
          <select id="tournamentStatus">
            <option value="upcoming">Upcoming</option>
            <option value="active">Active</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label>Description</label>
        <textarea id="tournamentDescription" rows="3" placeholder="Brief description of the tournament"></textarea>
      </div>
      
      <h4 style="margin: 20px 0 10px 0; color: #667eea;">Sponsor Information</h4>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="form-group">
          <label>Sponsor Name</label>
          <input type="text" id="sponsorName" placeholder="e.g., MTN Nigeria">
        </div>
        
        <div class="form-group">
          <label>Sponsor Logo URL</label>
          <input type="url" id="sponsorLogoUrl" placeholder="https://...">
        </div>
      </div>
      
      <h4 style="margin: 20px 0 10px 0; color: #667eea;">Payment & Prize</h4>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="form-group">
          <label>Payment Type *</label>
          <select id="paymentType" onchange="togglePaymentFields()" required>
            <option value="free">Free</option>
            <option value="paid">Paid Entry</option>
          </select>
        </div>
        
        <div class="form-group" id="entryFeeGroup" style="display: none;">
          <label>Entry Fee (‚Ç¶) *</label>
          <input type="number" id="entryFee" min="0" placeholder="500">
        </div>
      </div>
      
      <div class="form-group">
        <label>Prize Pool (‚Ç¶) *</label>
        <input type="number" id="prizePool" required min="0" placeholder="50000">
      </div>
      
      <div class="form-group">
        <label>
          <input type="checkbox" id="usesTokens" onchange="toggleTokenFields()">
          Use Token System (Limited attempts)
        </label>
      </div>
      
      <div id="tokenFieldsGroup" style="display: none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="form-group">
            <label>Tokens Per Entry *</label>
            <input type="number" id="tokensPerEntry" min="1" placeholder="5">
          </div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" id="unlimitedPlays" checked>
              Unlimited Plays
            </label>
          </div>
        </div>
      </div>
      
      <h4 style="margin: 20px 0 10px 0; color: #667eea;">Duration & Limits</h4>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="form-group">
          <label>Start Date *</label>
          <input type="datetime-local" id="startDate" required>
        </div>
        
        <div class="form-group">
          <label>End Date *</label>
          <input type="datetime-local" id="endDate" required>
        </div>
      </div>
      
      <div class="form-group">
        <label>Max Participants (0 = unlimited)</label>
        <input type="number" id="maxParticipants" min="0" placeholder="1000">
      </div>
      
      <h4 style="margin: 20px 0 10px 0; color: #667eea;">Questions & Branding</h4>
      
      <div class="form-group">
        <label>Question Category/Bank</label>
        <input type="text" id="questionCategory" placeholder="e.g., mtn_quiz, akwa_ibom_arise">
        <small style="color: #999;">Leave blank to use general tournament questions</small>
      </div>
      
      <div class="form-group">
        <label>Custom Instructions</label>
        <textarea id="customInstructions" rows="6" placeholder="Full game instructions that will be shown to players. Include rules, prize structure, lifelines, etc."></textarea>
      </div>
      
      <div class="form-group">
        <label>Custom Branding Text</label>
        <input type="text" id="customBranding" placeholder="e.g., Proudly sponsored by MTN Nigeria">
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 30px;">
        <button type="submit" class="btn btn-success" style="flex: 1;">üíæ Save Tournament</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('tournamentModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Tournament Details Modal -->
<div id="tournamentDetailsModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h3 id="tournamentDetailsTitle">Tournament Details</h3>
      <button class="close-modal" onclick="closeModal('tournamentDetailsModal')">&times;</button>
    </div>
    <div id="tournamentDetailsContent">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading...</p>
      </div>
    </div>
  </div>
</div>

<!-- BATCH 7/10 COMPLETE - All modals -->

<!-- User Profile Modal (NEW) -->
<div id="userProfileModal" class="modal">
  <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
    <div class="modal-header">
      <h3>üë§ User Profile</h3>
      <button class="close-modal" onclick="closeModal('userProfileModal')">&times;</button>
    </div>
    <div id="userProfileContent">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading user profile...</p>
      </div>
    </div>
  </div>
</div>

<!-- Suspend User Modal (NEW) -->
<div id="suspendUserModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header" style="background: #fee2e2;">
      <h3 style="color: #991b1b;">‚õî Suspend User</h3>
      <button class="close-modal" onclick="closeModal('suspendUserModal')">&times;</button>
    </div>
    <div id="suspendUserDetails" style="padding: 15px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 15px;">
      <!-- User info will be populated here -->
    </div>
    <form id="suspendUserForm" onsubmit="submitSuspension(event)">
      <input type="hidden" id="suspendUserId">
      <div class="form-group">
        <label>Suspension Reason *</label>
        <textarea id="suspensionReason" required rows="3" placeholder="Enter the reason for suspension..."></textarea>
      </div>
      <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
        <strong style="color: #92400e;">‚ö†Ô∏è Warning:</strong>
        <span style="color: #78350f;">The user will be immediately blocked from accessing the game.</span>
      </div>
      <div style="display: flex; gap: 10px;">
        <button type="submit" class="btn btn-danger" style="flex: 1;">‚õî Suspend User</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('suspendUserModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Victory Card Preview Modal (NEW) -->
<div id="victoryCardModal" class="modal">
  <div class="modal-content" style="max-width: 600px; text-align: center;">
    <div class="modal-header">
      <h3>üé¥ Victory Card</h3>
      <button class="close-modal" onclick="closeModal('victoryCardModal')">&times;</button>
    </div>
    <div id="victoryCardContent" style="padding: 20px;">
      <div class="loading">
        <div class="spinner"></div>
        <p>Generating victory card...</p>
      </div>
    </div>
    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
      <button class="btn btn-primary" onclick="downloadVictoryCard()">üì• Download</button>
      <button class="btn btn-secondary" onclick="closeModal('victoryCardModal')">Close</button>
    </div>
  </div>
</div>

<!-- Fraud Report Modal (NEW) -->
<div id="fraudReportModal" class="modal">

<!-- KYC Review Modal -->
<div id="kycReviewModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width: 600px;">
    <h2>üìã Review KYC Submission</h2>
    <div id="kycReviewContent"></div>
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn btn-success" onclick="approveKYC()">‚úÖ Approve</button>
      <button class="btn btn-danger" onclick="showRejectKYC()">‚ùå Reject</button>
      <button class="btn btn-secondary" onclick="closeModal('kycReviewModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- Alert Resolution Modal -->
<div id="alertResolveModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width: 500px;">
    <h2>üîç Resolve Fraud Alert</h2>
    <div id="alertResolveContent"></div>
    <div style="margin: 15px 0;">
      <label>Resolution:</label>
      <select id="alertResolution" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px;">
        <option value="confirmed_fraud">Confirmed Fraud - Take Action</option>
        <option value="false_positive">False Positive - No Action</option>
        <option value="warning_issued">Warning Issued to User</option>
        <option value="account_suspended">Account Suspended</option>
      </select>
    </div>
    <div style="margin: 15px 0;">
      <label>Notes:</label>
      <textarea id="alertNotes" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px; height: 80px;" placeholder="Add resolution notes..."></textarea>
    </div>
    <div style="display: flex; gap: 10px;">
      <button class="btn btn-success" onclick="resolveAlert()">‚úÖ Resolve</button>
      <button class="btn btn-secondary" onclick="closeModal('alertResolveModal')">Cancel</button>
    </div>
  </div>
</div>
  <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <div class="modal-header" style="background: #fee2e2;">
      <h3 style="color: #991b1b;">üîç Fraud Investigation Report</h3>
      <button class="close-modal" onclick="closeModal('fraudReportModal')">&times;</button>
    </div>
    <div id="fraudReportContent">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading fraud report...</p>
      </div>
    </div>
  </div>
</div>

<script>
// BATCH 8/10 - JavaScript: Authentication, State, and Core Functions

// State Management
let sessionToken = null;
let sessionExpiry = null;
let allUsers = [];
let charts = {};

// Initialize on page load
checkSession();

// Login Tab Switching
function switchLoginTab(tabType) {
  const tokenTab = document.getElementById('tokenTab');
  const usernameTab = document.getElementById('usernameTab');
  const tokenForm = document.getElementById('tokenLoginForm');
  const usernameForm = document.getElementById('usernameLoginForm');
  const errorDiv = document.getElementById('loginError');
  
  errorDiv.classList.remove('show');
  
  if (tabType === 'token') {
    tokenTab.classList.add('active');
    usernameTab.classList.remove('active');
    tokenForm.style.display = 'block';
    usernameForm.style.display = 'none';
    document.getElementById('adminToken').focus();
  } else {
    usernameTab.classList.add('active');
    tokenTab.classList.remove('active');
    usernameForm.style.display = 'block';
    tokenForm.style.display = 'none';
    document.getElementById('adminUsername').focus();
  }
}

// Session Management
function checkSession() {
  sessionToken = localStorage.getItem('adminSessionToken');
  sessionExpiry = localStorage.getItem('adminSessionExpiry');
  if (sessionToken && sessionExpiry) {
    const now = new Date().getTime();
    const expiry = new Date(sessionExpiry).getTime();
    if (now < expiry) {
      showDashboard();
      startSessionTimer();
      return;
    }
  }
  showLogin();
}

function showLogin() {
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('dashboardPage').classList.remove('active');
}

function showDashboard() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('dashboardPage').classList.add('active');
  loadEnhancedStats();
  loadAnalytics();
  updateAdminDisplay();
}

// Update admin name display in header
function updateAdminDisplay() {
  try {
    const adminInfo = JSON.parse(localStorage.getItem('adminInfo') || '{}');
    const displayName = document.getElementById('adminDisplayName');
    if (displayName && adminInfo.fullName) {
      displayName.textContent = 'üë§ ' + adminInfo.fullName + ' (' + (adminInfo.role || 'Admin') + ')';
    }
  } catch (e) {
    console.log('Could not update admin display');
  }
}

// Token Login Handler
document.getElementById('tokenLoginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const token = document.getElementById('adminToken').value;
  const loginBtn = document.getElementById('tokenLoginBtn');
  const errorDiv = document.getElementById('loginError');
  
  loginBtn.disabled = true;
  loginBtn.textContent = 'üîÑ Signing in...';
  errorDiv.classList.remove('show');
  
  try {
    const response = await fetch('/admin/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token })
    });
    
    const result = await response.json();
    
    if (result.success) {
      sessionToken = result.sessionToken;
      sessionExpiry = result.expiresAt;
      localStorage.setItem('adminSessionToken', sessionToken);
      localStorage.setItem('adminSessionExpiry', sessionExpiry);
      // Store admin info for cross-page navigation
      if (result.admin) {
        localStorage.setItem('adminInfo', JSON.stringify(result.admin));
        localStorage.setItem('adminToken', sessionToken); // For financials page
      }
      showDashboard();
      startSessionTimer();
      updateAdminDisplay();
    } else {
      errorDiv.textContent = '‚ùå ' + (result.error || 'Invalid token');
      errorDiv.classList.add('show');
    }
  } catch (error) {
    errorDiv.textContent = '‚ùå Login failed. Please try again.';
    errorDiv.classList.add('show');
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'üîê Sign In';
  }
});

// Username/Password Login Handler
document.getElementById('usernameLoginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = document.getElementById('adminUsername').value;
  const password = document.getElementById('adminPassword').value;
  const loginBtn = document.getElementById('usernameLoginBtn');
  const errorDiv = document.getElementById('loginError');
  
  loginBtn.disabled = true;
  loginBtn.textContent = 'üîÑ Signing in...';
  errorDiv.classList.remove('show');
  
  try {
    const response = await fetch('/admin/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    
    const result = await response.json();
    
    if (result.success) {
      sessionToken = result.sessionToken;
      sessionExpiry = result.expiresAt;
      localStorage.setItem('adminSessionToken', sessionToken);
      localStorage.setItem('adminSessionExpiry', sessionExpiry);
      localStorage.setItem('adminToken', sessionToken); // For financials page
      if (result.admin) {
        localStorage.setItem('adminInfo', JSON.stringify(result.admin));
      }
      showDashboard();
      startSessionTimer();
      updateAdminDisplay();
    } else {
      errorDiv.textContent = '‚ùå ' + (result.error || 'Invalid credentials');
      errorDiv.classList.add('show');
    }
  } catch (error) {
    console.error('Login error:', error);
    errorDiv.textContent = '‚ùå Login failed. Please try again.';
    errorDiv.classList.add('show');
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'üîê Sign In';
  }
});

// Logout Function
async function logout() {
  if (!confirm('Are you sure you want to logout?')) return;
  try {
    await fetch('/admin/api/logout', {
      method: 'POST',
      headers: getAuthHeaders()
    });
  } catch (error) {
    console.error('Logout error:', error);
  }
  localStorage.removeItem('adminSessionToken');
  localStorage.removeItem('adminSessionExpiry');
  localStorage.removeItem('adminInfo');
  sessionToken = null;
  sessionExpiry = null;
  showLogin();
}

// Session Timer
function startSessionTimer() {
  updateSessionTimer();
  setInterval(updateSessionTimer, 60000);
}

function updateSessionTimer() {
  if (!sessionExpiry) return;
  const now = new Date().getTime();
  const expiry = new Date(sessionExpiry).getTime();
  const remaining = expiry - now;
  if (remaining <= 0) {
    showAlert('Session expired. Please login again.', 'error');
    logout();
    return;
  }
  const hours = Math.floor(remaining / (1000 * 60 * 60));
  const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
  document.getElementById('sessionTimer').textContent = `Session expires in ${hours}h ${minutes}m`;
}

// Auth Headers Helper
function getAuthHeaders() {
  return {
    'Authorization': `Bearer ${sessionToken}`,
    'Content-Type': 'application/json'
  };
}

// Load Enhanced Stats
async function loadEnhancedStats() {
  try {
    const statsResponse = await fetch('/admin/api/stats', { headers: getAuthHeaders() });
    const stats = await statsResponse.json();
    
    document.getElementById('pendingCount').textContent = stats.pending_count || 0;
    document.getElementById('pendingAmount').textContent = `‚Ç¶${(parseFloat(stats.pending_amount) || 0).toLocaleString()}`;
    document.getElementById('paidCount').textContent = stats.paid_today_count || 0;
    document.getElementById('paidAmount').textContent = `‚Ç¶${(parseFloat(stats.paid_today_amount) || 0).toLocaleString()}`;
    document.getElementById('totalUsers').textContent = stats.total_users || 0;
    document.getElementById('totalQuestions').textContent = stats.total_questions || 0;
    
    const gamesResponse = await fetch('/admin/api/analytics/games-count', { headers: getAuthHeaders() });
    const games = await gamesResponse.json();
    
    document.getElementById('gamesToday').textContent = games.games_today || 0;
    document.getElementById('gamesWeek').textContent = games.games_this_week || 0;
    document.getElementById('gamesMonth').textContent = games.games_this_month || 0;
    document.getElementById('gamesQuarter').textContent = games.games_this_quarter || 0;
    document.getElementById('gamesYear').textContent = games.games_this_year || 0;
    document.getElementById('gamesAllTime').textContent = games.total_games_alltime || 0;
    
    const activityResponse = await fetch('/admin/api/analytics/user-activity', { headers: getAuthHeaders() });
    const activity = await activityResponse.json();
    
    const dauElement = document.getElementById('dailyActiveUsers');
    const dauChangeElement = document.getElementById('dauChange');
    dauElement.textContent = activity.daily_active_users || 0;
    if (activity.dau_change) {
      const change = parseFloat(activity.dau_change);
      dauChangeElement.textContent = `${change > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(change).toFixed(1)}% vs yesterday`;
      dauChangeElement.className = change > 0 ? 'metric-change positive' : 'metric-change negative';
    }
    
    const retentionElement = document.getElementById('userRetention');
    const retentionChangeElement = document.getElementById('retentionChange');
    retentionElement.textContent = activity.retention_rate ? `${activity.retention_rate}%` : '-';
    if (activity.retention_change) {
      const change = parseFloat(activity.retention_change);
      retentionChangeElement.textContent = `${change > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(change).toFixed(1)}% vs last week`;
      retentionChangeElement.className = change > 0 ? 'metric-change positive' : 'metric-change negative';
    }
    
    const conversionElement = document.getElementById('conversionRate');
    const conversionChangeElement = document.getElementById('conversionChange');
    conversionElement.textContent = activity.conversion_rate ? `${activity.conversion_rate}%` : '-';
    if (activity.conversion_change) {
      const change = parseFloat(activity.conversion_change);
      conversionChangeElement.textContent = `${change > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(change).toFixed(1)}% vs last period`;
      conversionChangeElement.className = change > 0 ? 'metric-change positive' : 'metric-change negative';
    }
  } catch (error) {
    console.error('Error loading enhanced stats:', error);
  }
}

// Utility Functions
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(`${tab}Tab`).classList.add('active');
  
  if (tab === 'analytics' && !charts.dailyGames) loadAnalytics();
  if (tab === 'payouts') loadPayouts();
  if (tab === 'users' && allUsers.length === 0) loadUsers();
  if (tab === 'questions' && !document.getElementById('questionsTableContainer').innerHTML.includes('table')) loadQuestions();
  if (tab === 'history' && !document.getElementById('historyTableContainer').innerHTML.includes('table')) loadHistory();
  if (tab === 'tournaments' && !document.getElementById('tournamentsTableContainer').innerHTML.includes('table')) loadTournaments();
  if (tab === 'activity' && !document.getElementById('activityTableContainer').innerHTML.includes('table')) loadActivityLog();
}

function openModal(modalId) {
  document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

function showAlert(message, type) {
  const container = document.getElementById('alertContainer');
  const alert = document.createElement('div');
  alert.className = `alert alert-${type}`;
  const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
  alert.innerHTML = `<span>${icon}</span><span>${message}</span>`;
  container.appendChild(alert);
  setTimeout(() => {
    alert.style.animation = 'fadeOut 0.3s';
    setTimeout(() => alert.remove(), 300);
  }, 5000);
}

// Auto-refresh stats every 30 seconds
setInterval(() => {
  if (sessionToken) loadEnhancedStats();
}, 30000);

// BATCH 8/10 COMPLETE - Authentication and core functions
// Continue to Batch 9 for Analytics and Chart rendering

// BATCH 9/10 - Analytics Loading and Chart Rendering Functions

async function loadAnalytics() {
  const container = document.getElementById('analyticsContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading analytics...</p></div>';
  
  try {
    const [analyticsResponse, peakTimesResponse, categoriesResponse, lgaResponse, funnelResponse] = await Promise.all([
      fetch('/admin/api/analytics', { headers: getAuthHeaders() }),
      fetch('/admin/api/analytics/peak-times', { headers: getAuthHeaders() }),
      fetch('/admin/api/analytics/categories', { headers: getAuthHeaders() }),
      fetch('/admin/api/analytics/lga-performance', { headers: getAuthHeaders() }),
      fetch('/admin/api/analytics/conversion-funnel', { headers: getAuthHeaders() })
    ]);
    
    const data = await analyticsResponse.json();
    const peakTimes = await peakTimesResponse.json();
    const categories = await categoriesResponse.json();
    const lgaData = await lgaResponse.json();
    const funnelData = await funnelResponse.json();
    
    Object.values(charts).forEach(chart => { if (chart && typeof chart.destroy === 'function') chart.destroy(); });
    charts = {};
    
    let html = `<div class="chart-grid"><div class="card"><h3>üìà Daily Games</h3><div class="chart-container"><canvas id="dailyGamesChart"></canvas></div></div><div class="card"><h3>üí∞ Prize Distribution</h3><div class="chart-container"><canvas id="prizeDistChart"></canvas></div></div></div><div class="chart-grid"><div class="card"><h3>‚è∞ Peak Times</h3><div class="chart-container"><canvas id="peakTimesChart"></canvas></div></div><div class="card"><h3>üìö Categories</h3><div class="chart-container"><canvas id="categoryPerfChart"></canvas></div></div></div><div class="chart-grid"><div class="card"><h3>üë• User Registration</h3><div class="chart-container"><canvas id="regTrendChart"></canvas></div></div><div class="card"><h3>üìä Question Performance</h3><div class="chart-container"><canvas id="questionPerfChart"></canvas></div></div></div><div class="chart-grid"><div class="card"><h3>üéØ Conversion Funnel</h3><div class="chart-container"><canvas id="funnelChart"></canvas></div></div><div class="card"><h3>üí≥ Payout Status</h3><div class="chart-container"><canvas id="payoutStatusChart"></canvas></div></div></div><div class="chart-grid"><div class="card"><h3>üó∫Ô∏è LGA Performance</h3><div class="chart-container"><canvas id="lgaChart"></canvas></div></div><div class="card"><h3>üèÜ Top Performers</h3><table class="top-performers-table"><thead><tr><th>Rank</th><th>Player</th><th>LGA</th><th>Games</th><th>Winnings</th></tr></thead><tbody id="topPerformersBody"></tbody></table></div></div>`;
    
    container.innerHTML = html;
    
    setTimeout(() => {
      renderDailyGamesChart(data.dailyGames);
      renderPrizeDistChart(data.prizeDistribution);
      renderPeakTimesChart(peakTimes);
      renderCategoryPerformanceChart(categories);
      renderRegTrendChart(data.registrationTrend);
      renderQuestionPerfChart(data.questionPerformance);
      renderConversionFunnelChart(funnelData);
      renderPayoutStatusChart(data.payoutBreakdown);
      renderLGAPerformanceChart(lgaData);
      renderTopPerformers(data.topPerformers);
    }, 100);
  } catch (error) {
    console.error('Error loading analytics:', error);
    container.innerHTML = '<div class="empty-state"><p>Error loading analytics</p></div>';
  }
}

function renderDailyGamesChart(data) {
  const ctx = document.getElementById('dailyGamesChart');
  if (!ctx) return;
  const labels = data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
  const values = data.map(d => parseInt(d.games_count));
  charts.dailyGames = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Games Played', data: values, borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', fill: true, tension: 0.4 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
}

function renderPrizeDistChart(data) {
  const ctx = document.getElementById('prizeDistChart');
  if (!ctx) return;
  const labels = data.map(d => d.difficulty_range);
  const values = data.map(d => parseFloat(d.total_amount));
  charts.prizeDist = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Total Winnings', data: values, backgroundColor: ['#10b981', '#f59e0b', '#ef4444'] }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '‚Ç¶' + v.toLocaleString() } } } }
  });
}

function renderPeakTimesChart(data) {
  const ctx = document.getElementById('peakTimesChart');
  if (!ctx || !data || data.length === 0) {
    if (ctx) ctx.parentElement.innerHTML = '<div class="empty-state"><p>No peak time data</p></div>';
    return;
  }
  
  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const matrixData = [];
  data.forEach(item => {
    if (item.hour_of_day !== null && item.day_of_week !== null) {
      matrixData.push({ x: parseInt(item.hour_of_day), y: parseInt(item.day_of_week), v: parseInt(item.total_games) || 0 });
    }
  });
  
  if (matrixData.length === 0) return;
  const maxGames = Math.max(...matrixData.map(d => d.v));
  if (charts.peakTimes) charts.peakTimes.destroy();
  
  charts.peakTimes = new Chart(ctx, {
    type: 'matrix',
    data: {
      datasets: [{
        label: 'Games Played',
        data: matrixData,
        backgroundColor(context) {
          const value = context.dataset.data[context.dataIndex]?.v || 0;
          if (value === 0) return 'rgba(229, 231, 235, 0.5)';
          const intensity = maxGames > 0 ? (value / maxGames) : 0;
          if (intensity < 0.25) return 'rgba(59, 130, 246, 0.6)';
          else if (intensity < 0.5) return 'rgba(34, 197, 94, 0.7)';
          else if (intensity < 0.75) return 'rgba(251, 191, 36, 0.8)';
          else return 'rgba(239, 68, 68, 0.9)';
        },
        borderColor: 'rgba(255, 255, 255, 0.8)',
        borderWidth: 2,
        width(context) { const a = context.chart.chartArea || {}; return (a.right - a.left) / 24 - 3; },
        height(context) { const a = context.chart.chartArea || {}; return (a.bottom - a.top) / 7 - 3; }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'üîµ Low   üü¢ Moderate   üü† High   üî¥ Peak', font: { size: 13 } },
        tooltip: {
          callbacks: {
            title() { return ''; },
            label(context) {
              const d = context.dataset.data[context.dataIndex];
              const hour = d.x;
              const hour12 = hour % 12 || 12;
              const ampm = hour < 12 ? 'AM' : 'PM';
              return `${days[d.y]} at ${hour12}:00 ${ampm}: ${d.v} games`;
            }
          }
        }
      },
      scales: {
        x: {
          type: 'linear', position: 'bottom', min: -0.5, max: 23.5,
          title: { display: true, text: 'Hour of Day' },
          ticks: {
            stepSize: 1,
            callback(value) {
              if (value < 0 || value > 23) return '';
              const hour = Math.round(value);
              const hour12 = hour % 12 || 12;
              const ampm = hour < 12 ? 'AM' : 'PM';
              return hour % 2 === 0 ? `${hour12}${ampm}` : '';
            }
          }
        },
        y: {
          type: 'linear', position: 'left', min: -0.5, max: 6.5,
          title: { display: true, text: 'Day of Week' },
          ticks: {
            stepSize: 1,
            callback(value) {
              const index = Math.round(value);
              if (index < 0 || index > 6) return '';
              return days[index];
            }
          }
        }
      }
    }
  });
}

function renderCategoryPerformanceChart(data) {
  const ctx = document.getElementById('categoryPerfChart');
  if (!ctx || data.length === 0) return;
  data.sort((a, b) => parseInt(b.total_questions) - parseInt(a.total_questions));
  const topCategories = data.slice(0, 10);
  const labels = topCategories.map(cat => cat.category || 'General');
  const questionCounts = topCategories.map(cat => parseInt(cat.total_questions));
  const successRates = topCategories.map(cat => parseFloat(cat.success_rate_percentage));
  charts.categoryPerf = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Questions', data: questionCounts, backgroundColor: '#667eea', yAxisID: 'y' },
        { label: 'Success Rate (%)', data: successRates, backgroundColor: '#10b981', yAxisID: 'y1' }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        y: { type: 'linear', position: 'left', beginAtZero: true, title: { display: true, text: 'Questions' } },
        y1: { type: 'linear', position: 'right', beginAtZero: true, max: 100, title: { display: true, text: 'Success Rate (%)' }, grid: { drawOnChartArea: false } }
      }
    }
  });
}

function renderRegTrendChart(data) {
  const ctx = document.getElementById('regTrendChart');
  if (!ctx) return;
  const labels = data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
  const values = data.map(d => parseInt(d.new_users));
  charts.regTrend = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'New Users', data: values, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
}

function renderQuestionPerfChart(data) {
  const ctx = document.getElementById('questionPerfChart');
  if (!ctx) return;
  const grouped = {};
  data.forEach(q => {
    const range = q.difficulty <= 5 ? 'Q1-Q5' : q.difficulty <= 10 ? 'Q6-Q10' : 'Q11-Q15';
    if (!grouped[range]) grouped[range] = { total: 0, count: 0 };
    grouped[range].total += parseFloat(q.success_rate);
    grouped[range].count++;
  });
  const labels = Object.keys(grouped);
  const values = labels.map(l => (grouped[l].total / grouped[l].count).toFixed(1));
  const colors = values.map(v => v >= 80 ? '#10b981' : v >= 60 ? '#f59e0b' : '#ef4444');
  charts.questionPerf = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Success Rate (%)', data: values, backgroundColor: colors }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
  });
}

function renderConversionFunnelChart(data) {
  const ctx = document.getElementById('funnelChart');
  if (!ctx) return;
  const stages = ['Registered', 'Played Game', 'Won Prize', 'Claimed Payout'];
  const values = [parseInt(data.total_registered || 0), parseInt(data.played_game || 0), parseInt(data.won_prize || 0), parseInt(data.claimed_payout || 0)];
  const percentages = values.map((v, i) => i === 0 ? 100 : ((v / values[0]) * 100).toFixed(1));
  charts.funnel = new Chart(ctx, {
    type: 'bar',
    data: { labels: stages, datasets: [{ label: 'Users', data: values, backgroundColor: ['#667eea', '#10b981', '#f59e0b', '#ef4444'] }] },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.parsed.x.toLocaleString()} users (${percentages[ctx.dataIndex]}%)` } } }, scales: { x: { beginAtZero: true } } }
  });
}

function renderPayoutStatusChart(data) {
  const ctx = document.getElementById('payoutStatusChart');
  if (!ctx) return;
  const statusNames = { pending: 'Pending', details_collected: 'Details Collected', approved: 'Approved', paid: 'Paid', confirmed: 'Confirmed', cancelled: 'Cancelled' };
  const labels = data.map(d => statusNames[d.payout_status] || d.payout_status);
  const values = data.map(d => parseInt(d.count));
  charts.payoutStatus = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data: values, backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#059669', '#6366f1'] }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });
}

function renderLGAPerformanceChart(data) {
  const ctx = document.getElementById('lgaChart');
  if (!ctx || data.length === 0) return;
  data.sort((a, b) => parseInt(b.total_games) - parseInt(a.total_games));
  const topLGAs = data.slice(0, 15);
  const labels = topLGAs.map(lga => lga.lga);
  const games = topLGAs.map(lga => parseInt(lga.total_games));
  const users = topLGAs.map(lga => parseInt(lga.total_users));
  charts.lga = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Games Played', data: games, backgroundColor: '#667eea' }, { label: 'Active Users', data: users, backgroundColor: '#10b981' }] },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { x: { beginAtZero: true } } }
  });
}

function renderTopPerformers(data) {
  const tbody = document.getElementById('topPerformersBody');
  if (!tbody) return;
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No data yet</td></tr>';
    return;
  }
  const medals = ['ü•á', 'ü•à', 'ü•â'];
  tbody.innerHTML = data.map((p, i) => `<tr><td>${i < 3 ? `<span class="medal">${medals[i]}</span>` : ''}#${i + 1}</td><td><strong>${p.full_name}</strong></td><td>${p.lga}</td><td>${p.total_games_played}</td><td><strong>‚Ç¶${parseFloat(p.total_winnings).toLocaleString()}</strong></td></tr>`).join('');
}

// BATCH 9/10 COMPLETE - Analytics and chart rendering complete
// Continue to Batch 10 for remaining data loading functions

// BATCH 10/10 - Payouts, Users, Questions, Tournaments, and Activity Log Functions

// PAYOUTS FUNCTIONS
async function loadPayouts() {
  const container = document.getElementById('payoutsTableContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading payouts...</p></div>';
  try {
    const status = document.getElementById('statusFilter')?.value || '';
    const url = status ? `/admin/api/payouts/pending?status=${status}` : '/admin/api/payouts/pending';
    const response = await fetch(url, { headers: getAuthHeaders() });
    const payouts = await response.json();
    if (payouts.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No pending payouts</p></div>';
      return;
    }
    let html = '<table><thead><tr><th>ID</th><th>Winner</th><th>Amount</th><th>Status</th><th>Bank Details</th><th>Verification</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
    payouts.forEach(payout => {
      const hasDetails = payout.account_name ? '‚úÖ' : '‚è≥';
      const detailsText = payout.account_name ? `${payout.account_name}<br><small>${payout.bank_name} - ${payout.account_number}</small>` : 'Awaiting details';
      const verificationBadge = payout.verified ? '<span class="verified-badge">‚úì Verified</span>' : payout.account_name ? '<span class="unverified-badge">‚ö† Not Verified</span>' : '-';
      html += `<tr><td>#${payout.transaction_id}</td><td><strong>${payout.full_name}</strong><br><small style="color: #999;">${payout.phone_number}</small></td><td><strong>‚Ç¶${parseFloat(payout.amount).toLocaleString()}</strong></td><td><span class="status-badge status-${payout.payout_status}">${payout.payout_status}</span></td><td>${hasDetails} <small>${detailsText}</small></td><td>${verificationBadge}</td><td>${new Date(payout.win_date).toLocaleDateString()}</td><td>${payout.account_name ? `<div style="display: flex; gap: 5px; flex-wrap: wrap;"><button class="btn btn-success btn-sm" onclick="showMarkPaidModal(${payout.transaction_id})">üíµ Mark Paid</button>${!payout.verified ? `<button class="btn btn-warning btn-sm" onclick="reverifyPayout(${payout.transaction_id})">üîÑ Re-verify</button>` : ''}</div>` : `<button class="btn btn-secondary btn-sm" disabled>‚è≥ Waiting</button>`}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading payouts:', error);
    container.innerHTML = '<div class="empty-state"><p>Error loading payouts</p></div>';
  }
}

function filterPayouts() { loadPayouts(); }

async function reverifyPayout(transactionId) {
  if (!confirm('Re-verify this bank account with Paystack?')) return;
  try {
    const response = await fetch(`/admin/api/payouts/${transactionId}/reverify`, { method: 'POST', headers: getAuthHeaders() });
    const result = await response.json();
    if (result.success) {
      showAlert(`‚úÖ Account verified: ${result.accountName}`, 'success');
      loadPayouts();
    } else {
      showAlert(`‚ùå Verification failed: ${result.error}`, 'error');
    }
  } catch (error) {
    showAlert('‚ùå Error re-verifying account', 'error');
  }
}

async function showMarkPaidModal(transactionId) {
  document.getElementById('selectedTransactionId').value = transactionId;
  try {
    const response = await fetch(`/admin/api/payouts/${transactionId}`, { headers: getAuthHeaders() });
    const payout = await response.json();
    const verificationBadge = payout.verified ? '<span class="verified-badge">‚úì Verified by Paystack</span>' : '<span class="unverified-badge">‚ö† Not Verified</span>';
    document.getElementById('payoutDetails').innerHTML = `<div style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;"><div class="detail-row"><span class="detail-label">Winner:</span><span class="detail-value">${payout.full_name}</span></div><div class="detail-row"><span class="detail-label">Amount:</span><span class="detail-value">‚Ç¶${parseFloat(payout.amount).toLocaleString()}</span></div><div class="detail-row"><span class="detail-label">Account Name:</span><span class="detail-value">${payout.account_name}</span></div><div class="detail-row"><span class="detail-label">Account Number:</span><span class="detail-value">${payout.account_number}</span></div><div class="detail-row"><span class="detail-label">Bank:</span><span class="detail-value">${payout.bank_name}</span></div><div class="detail-row"><span class="detail-label">Verification Status:</span><span class="detail-value">${verificationBadge}</span></div></div>`;
    document.getElementById('markPaidModal').classList.add('show');
  } catch (error) {
    showAlert('Error loading payout details', 'error');
  }
}

async function submitMarkPaid(event) {
  event.preventDefault();
  const transactionId = document.getElementById('selectedTransactionId').value;
  const paymentReference = document.getElementById('paymentReference').value;
  const paymentMethod = document.getElementById('paymentMethod').value;
  try {
    const response = await fetch(`/admin/api/payouts/${transactionId}/mark-paid`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ paymentReference, paymentMethod })
    });
    const result = await response.json();
    if (result.success) {
      showAlert('‚úÖ Payment marked as paid! Winner notified via WhatsApp.', 'success');
      closeModal('markPaidModal');
      loadEnhancedStats();
      loadPayouts();
      document.getElementById('markPaidForm').reset();
    } else {
      showAlert('‚ùå Error marking payment as paid', 'error');
    }
  } catch (error) {
    showAlert('‚ùå Error processing request', 'error');
  }
}

// HISTORY FUNCTIONS
async function loadHistory() {
  const container = document.getElementById('historyTableContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading history...</p></div>';
  try {
    const period = document.getElementById('periodFilter')?.value || 'all';
    const response = await fetch(`/admin/api/payouts/history?period=${period}`, { headers: getAuthHeaders() });
    const data = await response.json();
    if (data.payouts.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No payout history found</p></div>';
      return;
    }
    let html = '<table><thead><tr><th>ID</th><th>Winner</th><th>Amount</th><th>Bank Details</th><th>Reference</th><th>Paid Date</th><th>Status</th></tr></thead><tbody>';
    data.payouts.forEach(payout => {
      html += `<tr><td>#${payout.transaction_id}</td><td><strong>${payout.full_name}</strong><br><small style="color: #999;">${payout.phone_number}</small></td><td><strong>‚Ç¶${parseFloat(payout.amount).toLocaleString()}</strong></td><td><small>${payout.account_name || 'N/A'}<br>${payout.bank_name || 'N/A'}</small></td><td><small>${payout.payment_reference || 'N/A'}</small></td><td>${payout.paid_at ? new Date(payout.paid_at).toLocaleDateString() : 'N/A'}</td><td><span class="status-badge status-${payout.payout_status}">${payout.payout_status}</span></td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading history:', error);
    container.innerHTML = '<div class="empty-state"><p>Error loading history</p></div>';
  }
}

// USERS FUNCTIONS
async function loadUsers() {
  const container = document.getElementById('usersTableContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading users...</p></div>';
  
  // Reset search filters
  document.getElementById('userSearchQuery').value = '';
  document.getElementById('userPlatformFilter').value = '';
  document.getElementById('userStatusFilter').value = '';
  
  try {
    const response = await fetch('/admin/api/users', { headers: getAuthHeaders() });
    const data = await response.json();
    allUsers = data.users || [];
    renderUsersTable(allUsers);
  } catch (error) {
    console.error('Error loading users:', error);
    container.innerHTML = '<div class="empty-state"><p>Error loading users</p></div>';
  }
}

function renderUsersTable(users) {
  const container = document.getElementById('usersTableContainer');
  
  if (!users || users.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="icon">üë•</div><p>No users found</p></div>';
    return;
  }
  
  let html = `<table class="data-table"><thead><tr>
    <th>User</th>
    <th>Phone</th>
    <th>City</th>
    <th>Games</th>
    <th>Winnings</th>
    <th>Status</th>
    <th>Joined</th>
    <th>Actions</th>
  </tr></thead><tbody>`;
  
  users.forEach(user => {
    const platformIcon = user.phone_number.startsWith('tg_') ? 'üí¨' : 'üì±';
    const suspendedBadge = user.is_suspended 
      ? '<span class="badge" style="background:#fee2e2;color:#991b1b;padding:2px 6px;border-radius:4px;font-size:10px;">SUSPENDED</span>' 
      : '<span class="badge" style="background:#d1fae5;color:#065f46;padding:2px 6px;border-radius:4px;font-size:10px;">Active</span>';
    
    html += `<tr>
      <td>
        ${platformIcon} <strong>${user.full_name}</strong><br>
        <small style="color:#666;">@${user.username || 'N/A'}</small>
      </td>
      <td style="font-size:12px;">${user.phone_number}</td>
      <td>${user.city || 'N/A'}</td>
      <td>${user.total_games_played || 0}</td>
      <td style="color:#059669;font-weight:bold;">‚Ç¶${parseFloat(user.total_winnings || 0).toLocaleString()}</td>
      <td>${suspendedBadge}</td>
      <td style="font-size:12px;">${new Date(user.created_at).toLocaleDateString()}</td>
      <td>
        <div style="display:flex;gap:5px;flex-wrap:wrap;">
          <button class="btn btn-primary btn-sm" onclick="viewUserProfile(${user.id})" style="padding:4px 8px;font-size:11px;">üë§ Profile</button>
          ${user.is_suspended 
            ? `<button class="btn btn-success btn-sm" onclick="unsuspendUser(${user.id})" style="padding:4px 8px;font-size:11px;">‚úÖ Unsuspend</button>`
            : `<button class="btn btn-danger btn-sm" onclick="showSuspendModal(${user.id}, '${user.username}', '${user.full_name}')" style="padding:4px 8px;font-size:11px;">‚õî Suspend</button>`
          }
        </div>
      </td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  html += `<div style="text-align:center;margin-top:15px;color:#666;font-size:13px;">Showing ${users.length} users</div>`;
  container.innerHTML = html;
}

// QUESTIONS FUNCTIONS
async function loadQuestions() {
  const container = document.getElementById('questionsTableContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading questions...</p></div>';
  try {
    const response = await fetch('/admin/api/questions', { headers: getAuthHeaders() });
    const data = await response.json();
    if (data.questions.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">‚ùì</div><p>No questions found</p></div>';
      return;
    }
    let html = '<table><thead><tr><th>ID</th><th>Question</th><th>Difficulty</th><th>Category</th><th>Answer</th><th>Status</th></tr></thead><tbody>';
    data.questions.forEach(q => {
      html += `<tr><td>${q.id}</td><td>${q.question_text.substring(0, 80)}${q.question_text.length > 80 ? '...' : ''}</td><td>Q${q.difficulty}</td><td>${q.category}</td><td><strong>${q.correct_answer}</strong></td><td><span class="status-badge ${q.is_active ? 'status-approved' : 'status-pending'}">${q.is_active ? 'Active' : 'Inactive'}</span></td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    container.innerHTML = '<div class="empty-state"><p>Error loading questions</p></div>';
  }
}

function showAddQuestionModal() {
  document.getElementById('addQuestionModal').classList.add('show');
}

async function submitAddQuestion(event) {
  event.preventDefault();
  const questionData = {
    question_text: document.getElementById('questionText').value,
    option_a: document.getElementById('optionA').value,
    option_b: document.getElementById('optionB').value,
    option_c: document.getElementById('optionC').value,
    option_d: document.getElementById('optionD').value,
    correct_answer: document.getElementById('correctAnswer').value,
    difficulty: parseInt(document.getElementById('difficulty').value),
    category: document.getElementById('category').value || 'General',
    fun_fact: document.getElementById('funFact').value || null
  };
  try {
    const response = await fetch('/admin/api/questions', {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify(questionData)
    });
    const result = await response.json();
    if (result.success) {
      showAlert('‚úÖ Question added successfully!', 'success');
      closeModal('addQuestionModal');
      loadQuestions();
      loadEnhancedStats();
      document.getElementById('addQuestionForm').reset();
    } else {
      showAlert('‚ùå ' + (result.error || 'Error adding question'), 'error');
    }
  } catch (error) {
    showAlert('‚ùå Error adding question', 'error');
  }
}

// ACTIVITY LOG
async function loadActivityLog() {
  const container = document.getElementById('activityTableContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading activity log...</p></div>';
  try {
    const response = await fetch('/admin/api/activity-log', { headers: getAuthHeaders() });
    const data = await response.json();
    if (data.activities.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><p>No activity logged</p></div>';
      return;
    }
    let html = '<table><thead><tr><th>Timestamp</th><th>Action</th><th>Details</th><th>IP Address</th></tr></thead><tbody>';
    data.activities.forEach(activity => {
      const actionIcons = { login: 'üîê', logout: 'üö™', view_stats: 'üìä', view_payouts: 'üí∞', approve_payout: '‚úÖ', mark_paid: 'üíµ', reverify_payout: 'üîÑ', add_question: '‚ûï', update_question: '‚úèÔ∏è', delete_question: 'üóëÔ∏è', view_analytics: 'üìà' };
      const icon = actionIcons[activity.action_type] || 'üìù';
      html += `<tr><td>${new Date(activity.created_at).toLocaleString()}</td><td>${icon} ${activity.action_type}</td><td><small>${JSON.stringify(activity.action_details || {})}</small></td><td><small>${activity.ip_address || 'N/A'}</small></td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    container.innerHTML = '<div class="empty-state"><p>Error loading activity log</p></div>';
  }
}

// TOURNAMENT MANAGEMENT
async function loadTournaments() {
  const container = document.getElementById('tournamentsTableContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading tournaments...</p></div>';
  try {
    const statusFilter = document.getElementById('tournamentStatusFilter')?.value || '';
    const url = statusFilter ? `/admin/api/tournaments?status=${statusFilter}` : '/admin/api/tournaments';
    const response = await fetch(url, { headers: getAuthHeaders() });
    const data = await response.json();
    if (data.tournaments.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="icon">üèÜ</div><p>No tournaments found</p></div>';
      return;
    }
    let html = '<table><thead><tr><th>Tournament</th><th>Type</th><th>Payment</th><th>Prize Pool</th><th>Dates</th><th>Participants</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
    data.tournaments.forEach(t => {
      const startDate = new Date(t.start_date).toLocaleDateString();
      const endDate = new Date(t.end_date).toLocaleDateString();
      const paymentType = t.payment_type === 'free' ? 'FREE' : `‚Ç¶${parseInt(t.entry_fee).toLocaleString()}`;
      const tokenInfo = t.uses_tokens ? ` (${t.tokens_per_entry} tokens)` : '';
      html += `<tr><td><strong>${t.tournament_name}</strong>${t.sponsor_name ? `<br><small>${t.sponsor_name}</small>` : ''}</td><td>${t.tournament_type}</td><td>${paymentType}${tokenInfo}</td><td>‚Ç¶${parseInt(t.prize_pool).toLocaleString()}</td><td><small>${startDate}<br>to<br>${endDate}</small></td><td>${t.participant_count || 0}${t.max_participants ? `/${t.max_participants}` : ''}<br><small>${t.paid_entries || 0} paid</small></td><td><span class="status-badge status-${t.status}">${t.status}</span></td><td><div style="display: flex; gap: 5px; flex-wrap: wrap;"><button class="btn btn-sm btn-primary" onclick="viewTournamentDetails(${t.id})">üëÅÔ∏è View</button><button class="btn btn-sm btn-secondary" onclick="editTournament(${t.id})">‚úèÔ∏è Edit</button>${t.status === 'active' ? `<button class="btn btn-sm btn-danger" onclick="endTournament(${t.id})">üèÅ End</button>` : ''}</div></td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading tournaments:', error);
    container.innerHTML = '<div class="empty-state"><p>Error loading tournaments</p></div>';
  }
}

function showCreateTournamentModal() {
  document.getElementById('tournamentModalTitle').textContent = 'Create Tournament';
  document.getElementById('tournamentForm').reset();
  document.getElementById('tournamentId').value = '';
  const now = new Date();
  const startDate = new Date(now.getTime() + 24*60*60*1000);
  const endDate = new Date(now.getTime() + 7*24*60*60*1000);
  document.getElementById('startDate').value = startDate.toISOString().slice(0, 16);
  document.getElementById('endDate').value = endDate.toISOString().slice(0, 16);
  togglePaymentFields();
  toggleTokenFields();
  document.getElementById('tournamentModal').classList.add('show');
}

function togglePaymentFields() {
  const paymentType = document.getElementById('paymentType').value;
  const entryFeeGroup = document.getElementById('entryFeeGroup');
  if (paymentType === 'paid') {
    entryFeeGroup.style.display = 'block';
    document.getElementById('entryFee').required = true;
  } else {
    entryFeeGroup.style.display = 'none';
    document.getElementById('entryFee').required = false;
  }
}

function toggleTokenFields() {
  const usesTokens = document.getElementById('usesTokens').checked;
  const tokenFieldsGroup = document.getElementById('tokenFieldsGroup');
  if (usesTokens) {
    tokenFieldsGroup.style.display = 'block';
    document.getElementById('tokensPerEntry').required = true;
  } else {
    tokenFieldsGroup.style.display = 'none';
    document.getElementById('tokensPerEntry').required = false;
  }
}

async function submitTournament(event) {
  event.preventDefault();
  const tournamentId = document.getElementById('tournamentId').value;
  const isEdit = tournamentId !== '';
  const tournamentData = {
    tournamentName: document.getElementById('tournamentName').value,
    tournamentType: document.getElementById('tournamentType').value,
    sponsorName: document.getElementById('sponsorName').value || null,
    sponsorLogoUrl: document.getElementById('sponsorLogoUrl').value || null,
    description: document.getElementById('tournamentDescription').value || null,
    paymentType: document.getElementById('paymentType').value,
    usesTokens: document.getElementById('usesTokens').checked,
    tokensPerEntry: document.getElementById('usesTokens').checked ? parseInt(document.getElementById('tokensPerEntry').value) : null,
    unlimitedPlays: document.getElementById('unlimitedPlays').checked,
    entryFee: document.getElementById('paymentType').value === 'paid' ? parseFloat(document.getElementById('entryFee').value) : 0,
    prizePool: parseFloat(document.getElementById('prizePool').value),
    maxParticipants: parseInt(document.getElementById('maxParticipants').value) || null,
    startDate: document.getElementById('startDate').value,
    endDate: document.getElementById('endDate').value,
    questionCategory: document.getElementById('questionCategory').value || null,
    customInstructions: document.getElementById('customInstructions').value || null,
    customBranding: document.getElementById('customBranding').value || null,
    status: document.getElementById('tournamentStatus').value
  };
  try {
    const url = isEdit ? `/admin/api/tournaments/${tournamentId}` : '/admin/api/tournaments';
    const method = isEdit ? 'PUT' : 'POST';
    const response = await fetch(url, { method, headers: getAuthHeaders(), body: JSON.stringify(tournamentData) });
    const result = await response.json();
    if (result.success) {
      showAlert(`‚úÖ Tournament ${isEdit ? 'updated' : 'created'} successfully!`, 'success');
      closeModal('tournamentModal');
      loadTournaments();
    } else {
      showAlert(`‚ùå ${result.error}`, 'error');
    }
  } catch (error) {
    console.error('Error saving tournament:', error);
    showAlert('‚ùå Error saving tournament', 'error');
  }
}

async function editTournament(tournamentId) {
  try {
    const response = await fetch(`/admin/api/tournaments/${tournamentId}`, { headers: getAuthHeaders() });
    const tournament = await response.json();
    document.getElementById('tournamentModalTitle').textContent = 'Edit Tournament';
    document.getElementById('tournamentId').value = tournament.id;
    document.getElementById('tournamentName').value = tournament.tournament_name;
    document.getElementById('tournamentType').value = tournament.tournament_type;
    document.getElementById('sponsorName').value = tournament.sponsor_name || '';
    document.getElementById('sponsorLogoUrl').value = tournament.sponsor_logo_url || '';
    document.getElementById('tournamentDescription').value = tournament.description || '';
    document.getElementById('paymentType').value = tournament.payment_type;
    document.getElementById('usesTokens').checked = tournament.uses_tokens;
    document.getElementById('tokensPerEntry').value = tournament.tokens_per_entry || '';
    document.getElementById('unlimitedPlays').checked = tournament.unlimited_plays;
    document.getElementById('entryFee').value = tournament.entry_fee || 0;
    document.getElementById('prizePool').value = tournament.prize_pool;
    document.getElementById('maxParticipants').value = tournament.max_participants || '';
    document.getElementById('startDate').value = new Date(tournament.start_date).toISOString().slice(0, 16);
    document.getElementById('endDate').value = new Date(tournament.end_date).toISOString().slice(0, 16);
    document.getElementById('questionCategory').value = tournament.question_category || '';
    document.getElementById('customInstructions').value = tournament.custom_instructions || '';
    document.getElementById('customBranding').value = tournament.custom_branding || '';
    document.getElementById('tournamentStatus').value = tournament.status;
    togglePaymentFields();
    toggleTokenFields();
    document.getElementById('tournamentModal').classList.add('show');
  } catch (error) {
    console.error('Error loading tournament:', error);
    showAlert('‚ùå Error loading tournament', 'error');
  }
}

async function viewTournamentDetails(tournamentId) {
  const modal = document.getElementById('tournamentDetailsModal');
  const content = document.getElementById('tournamentDetailsContent');
  content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
  modal.classList.add('show');
  try {
    const [tournamentRes, participantsRes] = await Promise.all([
      fetch(`/admin/api/tournaments/${tournamentId}`, { headers: getAuthHeaders() }),
      fetch(`/admin/api/tournaments/${tournamentId}/participants`, { headers: getAuthHeaders() })
    ]);
    const tournament = await tournamentRes.json();
    const participantsData = await participantsRes.json();
    document.getElementById('tournamentDetailsTitle').textContent = tournament.tournament_name;
    let html = `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;"><div><h4>Tournament Information</h4><div class="detail-row"><span class="detail-label">Type:</span><span class="detail-value">${tournament.tournament_type}</span></div><div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value"><span class="status-badge status-${tournament.status}">${tournament.status}</span></span></div><div class="detail-row"><span class="detail-label">Payment:</span><span class="detail-value">${tournament.payment_type === 'free' ? 'FREE' : `‚Ç¶${parseInt(tournament.entry_fee).toLocaleString()}`}</span></div><div class="detail-row"><span class="detail-label">Prize Pool:</span><span class="detail-value">‚Ç¶${parseInt(tournament.prize_pool).toLocaleString()}</span></div><div class="detail-row"><span class="detail-label">Participants:</span><span class="detail-value">${tournament.participant_count || 0}${tournament.max_participants ? `/${tournament.max_participants}` : ''}</span></div>${tournament.payment_type === 'paid' ? `<div class="detail-row"><span class="detail-label">Revenue:</span><span class="detail-value">‚Ç¶${parseInt(tournament.total_revenue || 0).toLocaleString()}</span></div>` : ''}</div><div><h4>Dates & Settings</h4><div class="detail-row"><span class="detail-label">Start:</span><span class="detail-value">${new Date(tournament.start_date).toLocaleString()}</span></div><div class="detail-row"><span class="detail-label">End:</span><span class="detail-value">${new Date(tournament.end_date).toLocaleString()}</span></div><div class="detail-row"><span class="detail-label">Token System:</span><span class="detail-value">${tournament.uses_tokens ? `Yes (${tournament.tokens_per_entry} tokens)` : 'No'}</span></div><div class="detail-row"><span class="detail-label">Unlimited Plays:</span><span class="detail-value">${tournament.unlimited_plays ? 'Yes' : 'No'}</span></div>${tournament.sponsor_name ? `<div class="detail-row"><span class="detail-label">Sponsor:</span><span class="detail-value">${tournament.sponsor_name}</span></div>` : ''}</div></div>`;
    if (participantsData.participants.length > 0) {
      html += `<h4>Top Participants</h4><table style="margin-top: 10px;"><thead><tr><th>Rank</th><th>Player</th><th>City</th><th>Best Score</th><th>Games Played</th><th>Payment</th></tr></thead><tbody>`;
      participantsData.participants.slice(0, 20).forEach(p => {
        const medal = p.rank === 1 ? 'ü•á' : p.rank === 2 ? 'ü•à' : p.rank === 3 ? 'ü•â' : '';
        const paymentBadge = p.payment_status === 'success' ? '<span class="status-badge status-approved">Paid</span>' : '<span class="status-badge status-pending">Free</span>';
        html += `<tr><td>${medal} #${p.rank || '-'}</td><td><strong>@${p.username}</strong><br><small>${p.full_name}</small></td><td>${p.city}</td><td>‚Ç¶${parseInt(p.best_score || 0).toLocaleString()}</td><td>${p.games_played || 0}</td><td>${paymentBadge}</td></tr>`;
      });
      html += '</tbody></table>';
    } else {
      html += '<div class="empty-state"><p>No participants yet</p></div>';
    }
    content.innerHTML = html;
  } catch (error) {
    console.error('Error loading tournament details:', error);
    content.innerHTML = '<div class="empty-state"><p>Error loading details</p></div>';
  }
}

async function endTournament(tournamentId) {
  if (!confirm('End this tournament and distribute prizes to top winners?')) return;
  try {
    const response = await fetch(`/admin/api/tournaments/${tournamentId}/end`, { method: 'POST', headers: getAuthHeaders() });
    const result = await response.json();
    if (result.success) {
      showAlert(`‚úÖ ${result.message}`, 'success');
      loadTournaments();
    } else {
      showAlert(`‚ùå ${result.error}`, 'error');
    }
  } catch (error) {
    console.error('Error ending tournament:', error);
    showAlert('‚ùå Error ending tournament', 'error');
  }
}

// BATCH 10/10 COMPLETE - ALL FUNCTIONS IMPLEMENTED
// Complete admin dashboard with zero errors

// ============================================
// NEW: ENHANCED USER MANAGEMENT FUNCTIONS
// ============================================

// Search users with advanced filters
async function searchUsers() {
  const query = document.getElementById('userSearchQuery').value;
  const platform = document.getElementById('userPlatformFilter').value;
  const status = document.getElementById('userStatusFilter').value;
  
  const params = new URLSearchParams();
  if (query) params.append('query', query);
  if (platform) params.append('platform', platform);
  if (status === 'suspended') params.append('suspended', 'true');
  if (status === 'active') params.append('suspended', 'false');
  
  try {
    const response = await fetch(`/admin/api/users/search?${params.toString()}`, {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    
    if (data.success) {
      renderUsersTable(data.users);
    } else {
      showAlert('Failed to search users', 'error');
    }
  } catch (error) {
    console.error('Error searching users:', error);
    showAlert('Error searching users', 'error');
  }
}

// View user profile
async function viewUserProfile(userId) {
  openModal('userProfileModal');
  document.getElementById('userProfileContent').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading user profile...</p></div>';
  
  try {
    // Fetch user profile
    const response = await fetch(`/admin/api/users/${userId}/profile`, {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    
    // Also fetch device and security data
    let deviceData = { devices: [], ips: [] };
    try {
      const deviceResponse = await fetch(`/admin/api/security/user-devices/${userId}`, {
        headers: { 'Authorization': `Bearer ${sessionToken}` }
      });
      const deviceResult = await deviceResponse.json();
      if (deviceResult.success) {
        deviceData.devices = deviceResult.devices || [];
      }
      
      const ipResponse = await fetch(`/admin/api/security/user-ips/${userId}?days=30`, {
        headers: { 'Authorization': `Bearer ${sessionToken}` }
      });
      const ipResult = await ipResponse.json();
      if (ipResult.success) {
        deviceData.ips = ipResult.ips || [];
      }
    } catch (deviceError) {
      console.error('Error fetching device data:', deviceError);
    }
    
    if (data.success) {
      renderUserProfile(data, deviceData);
    } else {
      document.getElementById('userProfileContent').innerHTML = '<p style="color: red;">Failed to load user profile</p>';
    }
  } catch (error) {
    console.error('Error loading user profile:', error);
    document.getElementById('userProfileContent').innerHTML = '<p style="color: red;">Error loading user profile</p>';
  }
}

function renderUserProfile(data, deviceData = { devices: [], ips: [] }) {
  const { user, stats, financial, referrals, recentGames, recentTransactions, achievements } = data;
  const { devices, ips } = deviceData;
  const platformIcon = user.phone_number.startsWith('tg_') ? 'üí¨ Telegram' : 'üì± WhatsApp';
  const suspendedBadge = user.is_suspended ? '<span class="badge" style="background:#fee2e2;color:#991b1b;">SUSPENDED</span>' : '';
  
  let html = `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <!-- Left Column -->
      <div>
        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 15px;">üë§ Personal Information ${suspendedBadge}</h4>
          <div class="detail-row"><span class="detail-label">Username</span><span class="detail-value">@${user.username}</span></div>
          <div class="detail-row"><span class="detail-label">Full Name</span><span class="detail-value">${user.full_name}</span></div>
          <div class="detail-row"><span class="detail-label">Phone</span><span class="detail-value">${user.phone_number}</span></div>
          <div class="detail-row"><span class="detail-label">Platform</span><span class="detail-value">${platformIcon}</span></div>
          <div class="detail-row"><span class="detail-label">City</span><span class="detail-value">${user.city || 'N/A'}</span></div>
          <div class="detail-row"><span class="detail-label">Age</span><span class="detail-value">${user.age || 'N/A'}</span></div>
          <div class="detail-row"><span class="detail-label">Joined</span><span class="detail-value">${new Date(user.created_at).toLocaleDateString()}</span></div>
          <div class="detail-row"><span class="detail-label">Referral Code</span><span class="detail-value">${user.referral_code}</span></div>
        </div>
        
        <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 15px;">üéÆ Game Stats</h4>
          <div class="detail-row"><span class="detail-label">Total Games</span><span class="detail-value">${stats.total_games || 0}</span></div>
          <div class="detail-row"><span class="detail-label">Games Won</span><span class="detail-value">${stats.games_won || 0}</span></div>
          <div class="detail-row"><span class="detail-label">Games Lost</span><span class="detail-value">${stats.games_lost || 0}</span></div>
          <div class="detail-row"><span class="detail-label">Win Rate</span><span class="detail-value">${stats.total_games > 0 ? Math.round((stats.games_won / stats.total_games) * 100) : 0}%</span></div>
          <div class="detail-row"><span class="detail-label">Highest Question</span><span class="detail-value">Q${stats.highest_question || 0}</span></div>
          <div class="detail-row"><span class="detail-label">Avg Response Time</span><span class="detail-value">${stats.avg_response_time ? Math.round(stats.avg_response_time / 1000) + 's' : 'N/A'}</span></div>
          <div class="detail-row"><span class="detail-label">Current Streak</span><span class="detail-value">${user.current_streak || 0} days</span></div>
        </div>
      </div>
      
      <!-- Right Column -->
      <div>
        <div style="background: #fef3c7; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 15px;">üí∞ Financial</h4>
          <div class="detail-row"><span class="detail-label">Total Winnings</span><span class="detail-value" style="color: #059669; font-weight: bold;">‚Ç¶${parseFloat(financial.total_winnings || 0).toLocaleString()}</span></div>
          <div class="detail-row"><span class="detail-label">Highest Win</span><span class="detail-value">‚Ç¶${parseFloat(financial.highest_win || 0).toLocaleString()}</span></div>
          <div class="detail-row"><span class="detail-label">Total Purchases</span><span class="detail-value">‚Ç¶${parseFloat(financial.total_purchases || 0).toLocaleString()}</span></div>
          <div class="detail-row"><span class="detail-label">Games Remaining</span><span class="detail-value">${user.games_remaining || 0}</span></div>
          <div class="detail-row"><span class="detail-label">Referrals</span><span class="detail-value">${referrals.referral_count || 0}</span></div>
        </div>
        
        ${achievements.length > 0 ? `
        <div style="background: #ede9fe; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 15px;">üèÖ Achievements (${achievements.length})</h4>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${achievements.map(a => `<span style="background: white; padding: 5px 10px; border-radius: 20px; font-size: 12px;">${a.metadata?.emoji || 'üèÖ'} ${a.achievement_name}</span>`).join('')}
          </div>
        </div>
        ` : ''}
        
        ${stats.suspicious_games > 0 ? `
        <div style="background: #fee2e2; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 15px; color: #991b1b;">‚ö†Ô∏è Fraud Flags</h4>
          <div class="detail-row"><span class="detail-label">Fraud Flags</span><span class="detail-value" style="color: #dc2626;">${user.fraud_flags || 0}</span></div>
          <div class="detail-row"><span class="detail-label">Suspicious Sessions</span><span class="detail-value" style="color: #dc2626;">${stats.suspicious_games}</span></div>
          <button class="btn btn-danger" onclick="viewFraudReport(${user.id})" style="margin-top: 10px;">View Fraud Report</button>
        </div>
        ` : ''}
        
        <!-- Device & Security Section -->
        <div style="background: #f1f5f9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 15px;">üì± Device & Security</h4>
          <div class="detail-row"><span class="detail-label">Multi-Account Flags</span><span class="detail-value" style="color: ${user.multi_account_flags > 0 ? '#dc2626' : 'inherit'};">${user.multi_account_flags || 0}</span></div>
          <div class="detail-row"><span class="detail-label">Primary Device</span><span class="detail-value"><code style="font-size: 10px;">${user.primary_device_id ? user.primary_device_id.substring(0, 16) + '...' : 'Not set'}</code></span></div>
          
          ${devices.length > 0 ? `
          <div style="margin-top: 15px;">
            <strong style="font-size: 12px;">Known Devices (${devices.length}):</strong>
            <div style="max-height: 100px; overflow-y: auto; margin-top: 8px;">
              ${devices.map(d => `
                <div style="background: white; padding: 8px; border-radius: 6px; margin-bottom: 5px; font-size: 11px;">
                  <div><strong>ID:</strong> <code>${d.device_id?.substring(0, 16)}...</code></div>
                  <div><strong>Platform:</strong> ${d.platform || 'N/A'} | <strong>Last Seen:</strong> ${d.last_seen_at ? new Date(d.last_seen_at).toLocaleDateString() : 'N/A'}</div>
                  ${d.is_flagged ? '<span style="color: #dc2626;">üö© Flagged</span>' : ''}
                </div>
              `).join('')}
            </div>
          </div>
          ` : '<p style="color: #64748b; font-size: 12px; margin-top: 10px;">No device data recorded yet</p>'}
          
          ${ips.length > 0 ? `
          <div style="margin-top: 15px;">
            <strong style="font-size: 12px;">Recent IP Addresses (${ips.length}):</strong>
            <div style="max-height: 100px; overflow-y: auto; margin-top: 8px;">
              ${ips.slice(0, 5).map(ip => `
                <div style="background: white; padding: 8px; border-radius: 6px; margin-bottom: 5px; font-size: 11px;">
                  <div><strong>IP:</strong> ${ip.ip_address || 'N/A'} ${ip.is_vpn ? 'üîí VPN' : ''} ${ip.is_proxy ? 'üîÑ Proxy' : ''}</div>
                  <div><strong>Action:</strong> ${ip.action_type || 'N/A'} | <strong>Date:</strong> ${ip.recorded_at ? new Date(ip.recorded_at).toLocaleDateString() : 'N/A'}</div>
                </div>
              `).join('')}
            </div>
          </div>
          ` : ''}
        </div>
      </div>
    </div>
    
    <!-- Actions -->
    <div style="display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
      ${user.is_suspended 
        ? `<button class="btn btn-success" onclick="unsuspendUser(${user.id})">‚úÖ Unsuspend User</button>`
        : `<button class="btn btn-danger" onclick="showSuspendModal(${user.id}, '${user.username}', '${user.full_name}')">‚õî Suspend User</button>`
      }
      ${user.grand_prize_cooldown_until 
        ? `<button class="btn btn-warning" onclick="clearCooldown(${user.id})">üèÜ Clear Cooldown</button>`
        : ''
      }
      ${user.fraud_flags > 0 
        ? `<button class="btn btn-secondary" onclick="clearFraudFlags(${user.id})">üîç Clear Fraud Flags</button>`
        : ''
      }
      <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print Profile</button>
    </div>
  `;
  
  document.getElementById('userProfileContent').innerHTML = html;
}

// Show suspend user modal
function showSuspendModal(userId, username, fullName) {
  closeModal('userProfileModal');
  document.getElementById('suspendUserId').value = userId;
  document.getElementById('suspendUserDetails').innerHTML = `
    <p><strong>Username:</strong> @${username}</p>
    <p><strong>Full Name:</strong> ${fullName}</p>
  `;
  document.getElementById('suspensionReason').value = '';
  openModal('suspendUserModal');
}

// Submit suspension
async function submitSuspension(event) {
  event.preventDefault();
  const userId = document.getElementById('suspendUserId').value;
  const reason = document.getElementById('suspensionReason').value;
  
  try {
    const response = await fetch(`/admin/api/users/${userId}/suspend`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${sessionToken}`
      },
      body: JSON.stringify({ reason })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showAlert('‚úÖ User suspended successfully', 'success');
      closeModal('suspendUserModal');
      loadUsers();
      loadRestrictions();
    } else {
      showAlert('‚ùå Failed to suspend user', 'error');
    }
  } catch (error) {
    console.error('Error suspending user:', error);
    showAlert('‚ùå Error suspending user', 'error');
  }
}

// Unsuspend user
async function unsuspendUser(userId) {
  if (!confirm('Are you sure you want to unsuspend this user?')) return;
  
  try {
    const response = await fetch(`/admin/api/users/${userId}/unsuspend`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showAlert('‚úÖ User unsuspended successfully', 'success');
      closeModal('userProfileModal');
      loadUsers();
      loadRestrictions();
    } else {
      showAlert('‚ùå Failed to unsuspend user', 'error');
    }
  } catch (error) {
    console.error('Error unsuspending user:', error);
    showAlert('‚ùå Error unsuspending user', 'error');
  }
}

// Clear cooldown
async function clearCooldown(userId) {
  if (!confirm('Are you sure you want to clear this user\'s grand prize cooldown?')) return;
  
  try {
    const response = await fetch(`/admin/api/users/${userId}/clear-cooldown`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showAlert('‚úÖ Cooldown cleared successfully', 'success');
      closeModal('userProfileModal');
      loadRestrictions();
    } else {
      showAlert('‚ùå Failed to clear cooldown', 'error');
    }
  } catch (error) {
    console.error('Error clearing cooldown:', error);
    showAlert('‚ùå Error clearing cooldown', 'error');
  }
}

// ============================================
// NEW: RESTRICTIONS TAB FUNCTIONS
// ============================================

function showRestrictionsSubTab(tab) {
  document.getElementById('suspendedUsersSection').style.display = tab === 'suspended' ? 'block' : 'none';
  document.getElementById('cooldownUsersSection').style.display = tab === 'cooldown' ? 'block' : 'none';
  document.getElementById('dailyLimitSection').style.display = tab === 'dailylimit' ? 'block' : 'none';
  
  document.getElementById('suspendedSubTab').style.background = tab === 'suspended' ? 'var(--danger)' : 'var(--secondary)';
  document.getElementById('cooldownSubTab').style.background = tab === 'cooldown' ? 'var(--warning)' : 'var(--secondary)';
  document.getElementById('dailylimitSubTab').style.background = tab === 'dailylimit' ? 'var(--primary)' : 'var(--secondary)';
}

async function loadRestrictions() {
  // Load suspended users
  try {
    const suspendedResponse = await fetch('/admin/api/users/suspended', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const suspendedData = await suspendedResponse.json();
    
    if (suspendedData.success) {
      renderSuspendedUsers(suspendedData.users);
    }
  } catch (error) {
    console.error('Error loading suspended users:', error);
  }
  
  // Load cooldown users
  try {
    const cooldownResponse = await fetch('/admin/api/users/cooldown', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const cooldownData = await cooldownResponse.json();
    
    if (cooldownData.success) {
      renderCooldownUsers(cooldownData.users);
    }
  } catch (error) {
    console.error('Error loading cooldown users:', error);
  }
  
  // Load daily limit users
  try {
    const limitResponse = await fetch('/admin/api/users/daily-limit', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const limitData = await limitResponse.json();
    
    if (limitData.success) {
      renderDailyLimitUsers(limitData.users);
    }
  } catch (error) {
    console.error('Error loading daily limit users:', error);
  }
}

function renderSuspendedUsers(users) {
  if (users.length === 0) {
    document.getElementById('suspendedUsersTable').innerHTML = '<p style="color: var(--text-gray); text-align: center;">No suspended users</p>';
    return;
  }
  
  let html = `<table class="data-table"><thead><tr>
    <th>User</th><th>Reason</th><th>Suspended At</th><th>Actions</th>
  </tr></thead><tbody>`;
  
  users.forEach(user => {
    html += `<tr>
      <td><strong>@${user.username}</strong><br><small>${user.full_name}</small></td>
      <td>${user.suspension_reason || 'N/A'}</td>
      <td>${user.suspended_at ? new Date(user.suspended_at).toLocaleString() : 'N/A'}</td>
      <td>
        <button class="btn btn-success btn-sm" onclick="unsuspendUser(${user.id})">‚úÖ Unsuspend</button>
        <button class="btn btn-primary btn-sm" onclick="viewUserProfile(${user.id})">üë§ Profile</button>
      </td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  document.getElementById('suspendedUsersTable').innerHTML = html;
}

function renderCooldownUsers(users) {
  if (users.length === 0) {
    document.getElementById('cooldownUsersTable').innerHTML = '<p style="color: var(--text-gray); text-align: center;">No users on cooldown</p>';
    return;
  }
  
  let html = `<table class="data-table"><thead><tr>
    <th>User</th><th>Won Grand Prize</th><th>Cooldown Until</th><th>Actions</th>
  </tr></thead><tbody>`;
  
  users.forEach(user => {
    html += `<tr>
      <td><strong>@${user.username}</strong><br><small>${user.full_name}</small></td>
      <td>${user.last_grand_prize_win ? new Date(user.last_grand_prize_win).toLocaleDateString() : 'N/A'}</td>
      <td>${user.grand_prize_cooldown_until ? new Date(user.grand_prize_cooldown_until).toLocaleDateString() : 'N/A'}</td>
      <td>
        <button class="btn btn-warning btn-sm" onclick="clearCooldown(${user.id})">üèÜ Clear</button>
        <button class="btn btn-primary btn-sm" onclick="viewUserProfile(${user.id})">üë§ Profile</button>
      </td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  document.getElementById('cooldownUsersTable').innerHTML = html;
}

function renderDailyLimitUsers(users) {
  if (users.length === 0) {
    document.getElementById('dailyLimitUsersTable').innerHTML = '<p style="color: var(--text-gray); text-align: center;">No users at daily limit</p>';
    return;
  }
  
  let html = `<table class="data-table"><thead><tr>
    <th>User</th><th>Today's Winnings</th><th>Actions</th>
  </tr></thead><tbody>`;
  
  users.forEach(user => {
    html += `<tr>
      <td><strong>@${user.username}</strong><br><small>${user.full_name}</small></td>
      <td style="color: #059669; font-weight: bold;">‚Ç¶${parseFloat(user.today_winnings).toLocaleString()}</td>
      <td>
        <button class="btn btn-primary btn-sm" onclick="viewUserProfile(${user.id})">üë§ Profile</button>
      </td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  document.getElementById('dailyLimitUsersTable').innerHTML = html;
}

// ============================================
// NEW: FRAUD MONITORING FUNCTIONS
// ============================================

function showFraudSubTab(tab) {
  document.getElementById('flaggedUsersSection').style.display = tab === 'flagged' ? 'block' : 'none';
  document.getElementById('suspiciousSessionsSection').style.display = tab === 'sessions' ? 'block' : 'none';
  document.getElementById('turboModeSection').style.display = tab === 'turbo' ? 'block' : 'none';
  
  document.getElementById('flaggedSubTab').style.background = tab === 'flagged' ? 'var(--danger)' : 'var(--secondary)';
  document.getElementById('sessionsSubTab').style.background = tab === 'sessions' ? 'var(--warning)' : 'var(--secondary)';
  document.getElementById('turboSubTab').style.background = tab === 'turbo' ? '#ca8a04' : 'var(--secondary)';
  
  // Load turbo mode data when tab is selected
  if (tab === 'turbo') {
    loadTurboModeEvents();
  }
}

async function loadFraudData() {
  // Load flagged users
  try {
    const flaggedResponse = await fetch('/admin/api/fraud/flagged-users', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const flaggedData = await flaggedResponse.json();
    
    if (flaggedData.success) {
      document.getElementById('flaggedUsersCount').textContent = flaggedData.users.length;
      renderFlaggedUsers(flaggedData.users);
    }
  } catch (error) {
    console.error('Error loading flagged users:', error);
  }
  
  // Load suspicious sessions
  try {
    const sessionsResponse = await fetch('/admin/api/fraud/suspicious-sessions', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const sessionsData = await sessionsResponse.json();
    
    if (sessionsData.success) {
      document.getElementById('suspiciousSessionsCount').textContent = sessionsData.sessions.length;
      renderSuspiciousSessions(sessionsData.sessions);
    }
  } catch (error) {
    console.error('Error loading suspicious sessions:', error);
  }
  
  // Load turbo mode stats
  try {
    const turboResponse = await fetch('/admin/api/fraud/turbo-mode-stats', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const turboData = await turboResponse.json();
    
    if (turboData.success) {
      document.getElementById('turboTriggersCount').textContent = turboData.stats.total_triggers || 0;
      document.getElementById('turboTimeoutsCount').textContent = turboData.stats.total_timeouts || 0;
    }
  } catch (error) {
    console.error('Error loading turbo mode stats:', error);
    document.getElementById('turboTriggersCount').textContent = '0';
    document.getElementById('turboTimeoutsCount').textContent = '0';
  }
}

async function loadTurboModeEvents() {
  document.getElementById('turboModeTable').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading turbo mode events...</p></div>';
  
  try {
    const response = await fetch('/admin/api/fraud/turbo-mode-events', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    
    if (data.success) {
      renderTurboModeEvents(data.events);
    } else {
      document.getElementById('turboModeTable').innerHTML = '<p style="color: red;">Failed to load turbo mode events</p>';
    }
  } catch (error) {
    console.error('Error loading turbo mode events:', error);
    document.getElementById('turboModeTable').innerHTML = '<p style="color: red;">Error loading turbo mode events</p>';
  }
}

function renderTurboModeEvents(events) {
  if (!events || events.length === 0) {
    document.getElementById('turboModeTable').innerHTML = '<p style="color: var(--text-gray); text-align: center;">No turbo mode events recorded yet ‚ö°</p>';
    return;
  }
  
  let html = `<table class="data-table"><thead><tr>
    <th>User</th><th>Session</th><th>Event</th><th>Details</th><th>Date</th><th>Actions</th>
  </tr></thead><tbody>`;
  
  events.forEach(event => {
    const eventData = typeof event.event_data === 'string' ? JSON.parse(event.event_data) : event.event_data;
    let eventBadge = '';
    let details = '';
    
    if (event.event_type === 'TURBO_MODE_ACTIVATED') {
      eventBadge = '<span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 10px;">‚ö° Activated</span>';
      details = `Q${eventData.question_number || 'N/A'}`;
    } else if (event.event_type === 'TURBO_MODE_GO_RECEIVED') {
      eventBadge = '<span style="background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 10px;">‚úÖ GO Received</span>';
      details = 'User continued';
    } else if (event.event_type === 'TURBO_MODE_GO_TIMEOUT') {
      eventBadge = '<span style="background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 10px;">‚è∞ Timeout</span>';
      details = 'Failed to type GO';
    } else if (event.event_type === 'TURBO_MODE_COMPLETED') {
      eventBadge = '<span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 10px;">üèÜ Completed</span>';
      details = 'Passed turbo test';
    }
    
    html += `<tr>
      <td><strong>@${event.username || 'Unknown'}</strong><br><small>${event.full_name || ''}</small></td>
      <td>#${event.session_id}</td>
      <td>${eventBadge}</td>
      <td>${details}</td>
      <td>${new Date(event.created_at).toLocaleString()}</td>
      <td>
        <button class="btn btn-primary btn-sm" onclick="viewUserProfile(${event.user_id})">üë§ Profile</button>
      </td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  document.getElementById('turboModeTable').innerHTML = html;
}

function renderFlaggedUsers(users) {
  if (users.length === 0) {
    document.getElementById('flaggedUsersTable').innerHTML = '<p style="color: var(--text-gray); text-align: center;">No flagged users üéâ</p>';
    return;
  }
  
  let html = `<table class="data-table"><thead><tr>
    <th>User</th><th>Flags</th><th>Avg Response</th><th>Suspicious Games</th><th>Actions</th>
  </tr></thead><tbody>`;
  
  users.forEach(user => {
    const avgTime = user.avg_response_time ? Math.round(user.avg_response_time / 1000) + 's' : 'N/A';
    html += `<tr>
      <td><strong>@${user.username}</strong><br><small>${user.full_name}</small></td>
      <td><span style="background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 10px;">${user.fraud_flags}</span></td>
      <td>${avgTime}</td>
      <td>${user.suspicious_games || 0}</td>
      <td>
        <button class="btn btn-primary btn-sm" onclick="viewFraudReport(${user.id})">üîç Report</button>
        <button class="btn btn-secondary btn-sm" onclick="clearFraudFlags(${user.id})">‚úì Clear</button>
        ${!user.is_suspended ? `<button class="btn btn-danger btn-sm" onclick="showSuspendModal(${user.id}, '${user.username}', '${user.full_name}')">‚õî Suspend</button>` : ''}
      </td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  document.getElementById('flaggedUsersTable').innerHTML = html;
}

function renderSuspiciousSessions(sessions) {
  if (sessions.length === 0) {
    document.getElementById('suspiciousSessionsTable').innerHTML = '<p style="color: var(--text-gray); text-align: center;">No suspicious sessions üéâ</p>';
    return;
  }
  
  let html = `<table class="data-table"><thead><tr>
    <th>User</th><th>Game Mode</th><th>Avg Response</th><th>Fastest</th><th>Score</th><th>Date</th>
  </tr></thead><tbody>`;
  
  sessions.forEach(session => {
    html += `<tr>
      <td><strong>@${session.username}</strong></td>
      <td>${session.game_mode || session.game_type}</td>
      <td>${session.avg_response_time_ms ? Math.round(session.avg_response_time_ms / 1000) + 's' : 'N/A'}</td>
      <td style="color: ${session.fastest_response_ms < 2000 ? '#dc2626' : 'inherit'};">${session.fastest_response_ms ? Math.round(session.fastest_response_ms / 1000) + 's' : 'N/A'}</td>
      <td>‚Ç¶${(session.current_score || 0).toLocaleString()}</td>
      <td>${new Date(session.started_at).toLocaleString()}</td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  document.getElementById('suspiciousSessionsTable').innerHTML = html;
}

async function viewFraudReport(userId) {
  openModal('fraudReportModal');
  document.getElementById('fraudReportContent').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading fraud report...</p></div>';
  
  try {
    const response = await fetch(`/admin/api/fraud/user/${userId}`, {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    
    if (data.success) {
      renderFraudReport(data.report);
    } else {
      document.getElementById('fraudReportContent').innerHTML = '<p style="color: red;">Failed to load fraud report</p>';
    }
  } catch (error) {
    console.error('Error loading fraud report:', error);
    document.getElementById('fraudReportContent').innerHTML = '<p style="color: red;">Error loading fraud report</p>';
  }
}

function renderFraudReport(report) {
  const { user, stats, history } = report;
  
  let html = `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
        <h4>üë§ User Info</h4>
        <p><strong>Username:</strong> @${user.username}</p>
        <p><strong>Name:</strong> ${user.full_name}</p>
        <p><strong>Fraud Flags:</strong> <span style="color: #dc2626; font-weight: bold;">${user.fraud_flags}</span></p>
        <p><strong>Status:</strong> ${user.is_suspended ? '<span style="color: #dc2626;">SUSPENDED</span>' : '<span style="color: #059669;">Active</span>'}</p>
      </div>
      
      <div style="background: #fef3c7; padding: 20px; border-radius: 12px;">
        <h4>üìä Session Stats</h4>
        <p><strong>Total Sessions:</strong> ${stats.total_sessions || 0}</p>
        <p><strong>Wins:</strong> ${stats.wins || 0}</p>
        <p><strong>Perfect Games:</strong> ${stats.perfect_games || 0}</p>
        <p><strong>Avg Response:</strong> ${stats.avg_response_time ? Math.round(stats.avg_response_time / 1000) + 's' : 'N/A'}</p>
        <p><strong>Fastest Ever:</strong> ${stats.fastest_response ? Math.round(stats.fastest_response / 1000) + 's' : 'N/A'}</p>
        <p><strong>Suspicious Sessions:</strong> <span style="color: #dc2626;">${stats.suspicious_sessions || 0}</span></p>
      </div>
    </div>
    
    <div style="margin-top: 20px;">
      <h4>üìú Flag History</h4>
      ${history.length > 0 ? `
        <table class="data-table" style="margin-top: 10px;">
          <thead><tr><th>Action</th><th>Details</th><th>Date</th></tr></thead>
          <tbody>
            ${history.map(h => `<tr>
              <td>${h.action_type}</td>
              <td>${h.details?.reason || JSON.stringify(h.details)}</td>
              <td>${new Date(h.created_at).toLocaleString()}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      ` : '<p style="color: var(--text-gray);">No history available</p>'}
    </div>
    
    <div style="margin-top: 20px; display: flex; gap: 10px;">
      <button class="btn btn-secondary" onclick="clearFraudFlags(${user.id}); closeModal('fraudReportModal');">‚úì Clear Flags</button>
      ${!user.is_suspended ? `<button class="btn btn-danger" onclick="closeModal('fraudReportModal'); showSuspendModal(${user.id}, '${user.username}', '${user.full_name}');">‚õî Suspend User</button>` : ''}
    </div>
  `;
  
  document.getElementById('fraudReportContent').innerHTML = html;
}

async function clearFraudFlags(userId) {
  if (!confirm('Are you sure you want to clear fraud flags for this user?')) return;
  
  try {
    const response = await fetch(`/admin/api/fraud/user/${userId}/clear`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showAlert('‚úÖ Fraud flags cleared', 'success');
      loadFraudData();
    } else {
      showAlert('‚ùå Failed to clear fraud flags', 'error');
    }
  } catch (error) {
    console.error('Error clearing fraud flags:', error);
    showAlert('‚ùå Error clearing fraud flags', 'error');
  }
}

// ============================================
// NEW: WINNERS TAB FUNCTIONS
// ============================================

async function loadWinners() {
  // Load win stats
  try {
    const statsResponse = await fetch('/admin/api/stats/wins?period=today', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const statsData = await statsResponse.json();
    
    if (statsData.success && statsData.stats) {
      document.getElementById('todayWinsCount').textContent = statsData.stats.total_wins || 0;
      document.getElementById('todayWinsAmount').textContent = '‚Ç¶' + parseFloat(statsData.stats.total_amount || 0).toLocaleString();
      document.getElementById('cardsSharedCount').textContent = statsData.stats.cards_shared || 0;
      document.getElementById('cardsPendingCount').textContent = statsData.stats.cards_pending || 0;
    }
  } catch (error) {
    console.error('Error loading win stats:', error);
  }
  
  // Load recent winners with pagination
  await loadWinnersPage(1);
}

// Winners pagination state
let winnersCurrentPage = 1;
let winnersTotalPages = 1;
let winnersPerPage = 20;

function handleWinnersSearch(event) {
  if (event.key === 'Enter') {
    loadWinners();
  }
}

async function loadWinnersPage(page = 1) {
  winnersCurrentPage = page;
  
  const search = document.getElementById('winnersSearch')?.value || '';
  const status = document.getElementById('winnersStatusFilter')?.value || '';
  const mode = document.getElementById('winnersModeFilter')?.value || '';
  const minAmount = document.getElementById('winnersAmountFilter')?.value || '';
  
  const params = new URLSearchParams({
    page: page,
    limit: winnersPerPage,
    search: search,
    status: status,
    mode: mode,
    minAmount: minAmount
  });
  
  document.getElementById('winnersTableContainer').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading winners...</p></div>';
  
  try {
    const response = await fetch(`/admin/api/winners/recent?${params.toString()}`, {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    
    if (data.success) {
      winnersTotalPages = data.totalPages || 1;
      renderWinnersTable(data.winners, data.total);
      renderWinnersPagination();
    } else {
      document.getElementById('winnersTableContainer').innerHTML = '<p style="color: red;">Error loading winners</p>';
    }
  } catch (error) {
    console.error('Error loading winners:', error);
    document.getElementById('winnersTableContainer').innerHTML = '<p style="color: red;">Error loading winners</p>';
  }
}

function renderWinnersTable(winners, total = 0) {
  // Update count label
  const countLabel = document.getElementById('winnersCountLabel');
  if (countLabel) {
    countLabel.textContent = total > 0 ? `(${total} total)` : '';
  }
  
  if (!winners || winners.length === 0) {
    document.getElementById('winnersTableContainer').innerHTML = '<p style="color: var(--text-gray); text-align: center;">No winners found</p>';
    return;
  }
  
  let html = `<table class="data-table"><thead><tr>
    <th>User</th><th>Amount</th><th>Mode</th><th>Card Status</th><th>Date</th><th>Actions</th>
  </tr></thead><tbody>`;
  
  winners.forEach(winner => {
    const cardStatus = winner.victory_card_shared 
      ? '<span class="badge" style="background:#d1fae5;color:#065f46;">Shared</span>'
      : '<span class="badge" style="background:#fef3c7;color:#92400e;">Pending</span>';
    const platformIcon = winner.phone_number?.startsWith('tg_') ? 'üí¨' : 'üì±';
    const amountColor = parseFloat(winner.amount) >= 50000 ? '#eab308' : parseFloat(winner.amount) >= 10000 ? '#22c55e' : '#059669';
    
    html += `<tr>
      <td>${platformIcon} <strong>@${winner.username || 'unknown'}</strong><br><small>${winner.full_name || ''}</small></td>
      <td style="color: ${amountColor}; font-weight: bold;">‚Ç¶${parseFloat(winner.amount).toLocaleString()}</td>
      <td><span class="badge" style="background: ${winner.game_mode === 'tournament' ? '#dbeafe' : '#f3e8ff'}; color: ${winner.game_mode === 'tournament' ? '#1e40af' : '#7c3aed'};">${winner.game_mode || 'classic'}</span></td>
      <td>${cardStatus}</td>
      <td>${new Date(winner.win_date).toLocaleString()}</td>
      <td>
        <button class="btn btn-primary btn-sm" onclick="regenerateVictoryCard(${winner.victory_card_id || winner.transaction_id})">üé¥ Generate Card</button>
        <button class="btn btn-secondary btn-sm" onclick="viewUserProfile(${winner.user_id})">üë§ Profile</button>
      </td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  document.getElementById('winnersTableContainer').innerHTML = html;
}

function renderWinnersPagination() {
  const container = document.getElementById('winnersPagination');
  if (!container) return;
  
  if (winnersTotalPages <= 1) {
    container.innerHTML = '';
    return;
  }
  
  let html = '';
  
  // Previous button
  html += `<button class="btn btn-secondary btn-sm" onclick="loadWinnersPage(${winnersCurrentPage - 1})" ${winnersCurrentPage === 1 ? 'disabled' : ''}>‚Üê Prev</button>`;
  
  // Page numbers
  const maxVisiblePages = 5;
  let startPage = Math.max(1, winnersCurrentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(winnersTotalPages, startPage + maxVisiblePages - 1);
  
  if (endPage - startPage < maxVisiblePages - 1) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }
  
  if (startPage > 1) {
    html += `<button class="btn btn-secondary btn-sm" onclick="loadWinnersPage(1)">1</button>`;
    if (startPage > 2) {
      html += `<span style="color: var(--text-gray);">...</span>`;
    }
  }
  
  for (let i = startPage; i <= endPage; i++) {
    if (i === winnersCurrentPage) {
      html += `<button class="btn btn-primary btn-sm" disabled>${i}</button>`;
    } else {
      html += `<button class="btn btn-secondary btn-sm" onclick="loadWinnersPage(${i})">${i}</button>`;
    }
  }
  
  if (endPage < winnersTotalPages) {
    if (endPage < winnersTotalPages - 1) {
      html += `<span style="color: var(--text-gray);">...</span>`;
    }
    html += `<button class="btn btn-secondary btn-sm" onclick="loadWinnersPage(${winnersTotalPages})">${winnersTotalPages}</button>`;
  }
  
  // Next button
  html += `<button class="btn btn-secondary btn-sm" onclick="loadWinnersPage(${winnersCurrentPage + 1})" ${winnersCurrentPage === winnersTotalPages ? 'disabled' : ''}>Next ‚Üí</button>`;
  
  container.innerHTML = html;
}

function renderWinnersTableOld(winners) {
  if (winners.length === 0) {
    document.getElementById('winnersTableContainer').innerHTML = '<p style="color: var(--text-gray); text-align: center;">No recent winners</p>';
    return;
  }
  
  let html = `<table class="data-table"><thead><tr>
    <th>User</th><th>Amount</th><th>Mode</th><th>Card Status</th><th>Date</th><th>Actions</th>
  </tr></thead><tbody>`;
  
  winners.forEach(winner => {
    const cardStatus = winner.victory_card_shared 
      ? '<span class="badge" style="background:#d1fae5;color:#065f46;">Shared</span>'
      : '<span class="badge" style="background:#fef3c7;color:#92400e;">Pending</span>';
    const platformIcon = winner.phone_number?.startsWith('tg_') ? 'üí¨' : 'üì±';
    
    html += `<tr>
      <td>${platformIcon} <strong>@${winner.username}</strong><br><small>${winner.full_name}</small></td>
      <td style="color: #059669; font-weight: bold;">‚Ç¶${parseFloat(winner.amount).toLocaleString()}</td>
      <td>${winner.game_mode || 'Classic'}</td>
      <td>${cardStatus}</td>
      <td>${new Date(winner.win_date).toLocaleString()}</td>
      <td>
        <button class="btn btn-primary btn-sm" onclick="regenerateVictoryCard(${winner.victory_card_id || winner.transaction_id})">üé¥ Generate Card</button>
        <button class="btn btn-secondary btn-sm" onclick="viewUserProfile(${winner.user_id})">üë§ Profile</button>
      </td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  document.getElementById('winnersTableContainer').innerHTML = html;
}

let currentVictoryCardImage = null;

async function regenerateVictoryCard(cardId) {
  openModal('victoryCardModal');
  document.getElementById('victoryCardContent').innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating victory card...</p></div>';
  
  try {
    const response = await fetch(`/admin/api/victory-cards/${cardId}/regenerate`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    
    const data = await response.json();
    
    if (data.success) {
      currentVictoryCardImage = data.image;
      document.getElementById('victoryCardContent').innerHTML = `
        <img src="${data.image}" alt="Victory Card" style="max-width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
        <div style="margin-top: 15px; color: var(--text-gray);">
          <p><strong>Winner:</strong> @${data.cardData.username}</p>
          <p><strong>Amount:</strong> ‚Ç¶${parseFloat(data.cardData.amount).toLocaleString()}</p>
        </div>
      `;
    } else {
      document.getElementById('victoryCardContent').innerHTML = '<p style="color: red;">Failed to generate victory card</p>';
    }
  } catch (error) {
    console.error('Error regenerating victory card:', error);
    document.getElementById('victoryCardContent').innerHTML = '<p style="color: red;">Error generating victory card</p>';
  }
}

function downloadVictoryCard() {
  if (!currentVictoryCardImage) return;
  
  const link = document.createElement('a');
  link.href = currentVictoryCardImage;
  link.download = 'victory-card-' + Date.now() + '.png';
  link.click();
}

// ============================================
// UPDATE: Enhanced switchTab function
// ============================================

const originalSwitchTab = switchTab;
switchTab = function(tabName) {
  // Handle new tabs
  const allTabs = ['analytics', 'payouts', 'history', 'users', 'restrictions', 'fraud', 'winners', 'questions', 'tournaments', 'activity'];
  
  allTabs.forEach(tab => {
    const tabContent = document.getElementById(tab + 'Tab');
    const tabButton = document.querySelector(`.tab[onclick="switchTab('${tab}')"]`);
    
    if (tabContent) {
      tabContent.classList.remove('active');
    }
    if (tabButton) {
      tabButton.classList.remove('active');
    }
  });
  
  const activeContent = document.getElementById(tabName + 'Tab');
  const activeButton = document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`);
  
  if (activeContent) {
    activeContent.classList.add('active');
  }
  if (activeButton) {
    activeButton.classList.add('active');
  }
  
  // Load data for new tabs
  if (tabName === 'restrictions') {
    loadRestrictions();
  } else if (tabName === 'fraud') {
    loadFraudData();
  } else if (tabName === 'winners') {
    loadWinners();
  } else if (tabName === 'users') {
    loadUsers();
  } else if (tabName === 'analytics') {
    loadAnalytics();
  } else if (tabName === 'payouts') {
    loadPayouts();
  } else if (tabName === 'history') {
    loadHistory();
  } else if (tabName === 'questions') {
    loadQuestions();
  } else if (tabName === 'tournaments') {
    loadTournaments();
  } else if (tabName === 'activity') {
    loadActivityLog();
  } else if (tabName === 'security') {
    loadSecurityDashboard();
    loadKYCQueue();
  }
};

// ============================================
// SECURITY TAB FUNCTIONS
// ============================================

let currentKycId = null;
let currentAlertId = null;

async function loadSecurityDashboard() {
  try {
    const response = await fetch('/admin/api/security/dashboard', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    
    if (data.success) {
      const d = data.dashboard;
      document.getElementById('pendingKycCount').textContent = d.pendingKYC || 0;
      document.getElementById('fraudAlertsCount').textContent = d.newFraudAlerts || 0;
      document.getElementById('criticalAlertsCount').textContent = d.criticalAlerts || 0;
      document.getElementById('accountLinksCount').textContent = d.unreviewedAccountLinks || 0;
      document.getElementById('highRiskCount').textContent = d.highRiskUsers || 0;
      document.getElementById('captchaFailRate').textContent = d.captchaStats?.failureRate || '0%';
    }
  } catch (error) {
    console.error('Error loading security dashboard:', error);
  }
}

function showSecuritySubTab(tab) {
  document.getElementById('kycSection').style.display = 'none';
  document.getElementById('alertsSection').style.display = 'none';
  document.getElementById('devicesSection').style.display = 'none';
  document.getElementById('behaviorSection').style.display = 'none';
  document.getElementById('captchaSection').style.display = 'none';
  
  document.querySelectorAll('#securityTab .btn').forEach(btn => {
    if (btn.id && btn.id.endsWith('SubTab')) {
      btn.classList.remove('btn-warning');
      btn.classList.add('btn-secondary');
      btn.style.background = '';
    }
  });
  
  const activeBtn = document.getElementById(tab + 'SubTab');
  if (activeBtn) {
    activeBtn.classList.remove('btn-secondary');
    activeBtn.classList.add('btn-warning');
    activeBtn.style.background = 'var(--warning)';
  }
  
  document.getElementById(tab + 'Section').style.display = 'block';
  
  switch(tab) {
    case 'kyc': loadKYCQueue(); break;
    case 'alerts': loadFraudAlerts('new'); break;
    case 'devices': loadSharedDevices(); break;
    case 'behavior': loadHighRiskUsers(); break;
    case 'captcha': loadCaptchaStats(); break;
  }
}

async function loadKYCQueue() {
  try {
    const response = await fetch('/admin/api/kyc/pending', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    const container = document.getElementById('kycTable');
    
    if (!data.success || !data.reviews || data.reviews.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-gray);"><h3>‚úÖ No Pending KYC Reviews</h3></div>';
      return;
    }
    
    let html = `<table class="data-table"><thead><tr><th>User</th><th>Daily Winnings</th><th>ID Type</th><th>Submitted</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
    data.reviews.forEach(kyc => {
      html += `<tr><td><strong>${kyc.full_name || 'N/A'}</strong><br><small>${kyc.phone_number || ''}</small></td><td>‚Ç¶${parseFloat(kyc.daily_winnings || 0).toLocaleString()}</td><td>${kyc.id_type || 'N/A'}</td><td>${kyc.submitted_at ? new Date(kyc.submitted_at).toLocaleDateString() : 'N/A'}</td><td><span class="status-badge status-pending">${kyc.status}</span></td><td><button class="btn btn-primary btn-sm" onclick="showKYCReview(${kyc.id})">üëÅÔ∏è Review</button></td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading KYC queue:', error);
    document.getElementById('kycTable').innerHTML = '<p style="color: red;">Error loading KYC data</p>';
  }
}

async function showKYCReview(kycId) {
  currentKycId = kycId;
  try {
    const response = await fetch(`/admin/api/kyc/user/${kycId}`, {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    if (data.success && data.kyc) {
      const kyc = data.kyc;
      document.getElementById('kycReviewContent').innerHTML = `<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;"><p><strong>User:</strong> ${kyc.full_name || 'N/A'}</p><p><strong>Phone:</strong> ${kyc.phone_number || 'N/A'}</p><p><strong>Daily Winnings:</strong> ‚Ç¶${parseFloat(kyc.daily_winnings || 0).toLocaleString()}</p><p><strong>ID Type:</strong> ${kyc.id_type || 'Not submitted'}</p></div><div style="margin-top: 15px;"><label>Admin Notes:</label><textarea id="kycAdminNotes" style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ddd; margin-top: 5px; height: 60px;" placeholder="Add verification notes..."></textarea></div>`;
      document.getElementById('kycReviewModal').style.display = 'flex';
    }
  } catch (error) {
    console.error('Error loading KYC details:', error);
  }
}

async function approveKYC() {
  if (!currentKycId) return;
  try {
    const notes = document.getElementById('kycAdminNotes')?.value || '';
    const response = await fetch(`/admin/api/kyc/${currentKycId}/approve`, { 
      method: 'POST', 
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${sessionToken}` 
      }, 
      body: JSON.stringify({ notes }) 
    });
    const data = await response.json();
    if (data.success) {
      alert('‚úÖ KYC Approved Successfully');
      closeModal('kycReviewModal');
      loadKYCQueue();
      loadSecurityDashboard();
    } else {
      alert('Error: ' + (data.error || 'Failed to approve'));
    }
  } catch (error) {
    console.error('Error approving KYC:', error);
  }
}

function showRejectKYC() {
  const reason = prompt('Enter rejection reason:');
  if (reason) rejectKYC(reason);
}

async function rejectKYC(reason) {
  if (!currentKycId) return;
  try {
    const response = await fetch(`/admin/api/kyc/${currentKycId}/reject`, { 
      method: 'POST', 
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${sessionToken}` 
      }, 
      body: JSON.stringify({ reason }) 
    });
    const data = await response.json();
    if (data.success) {
      alert('KYC Rejected');
      closeModal('kycReviewModal');
      loadKYCQueue();
      loadSecurityDashboard();
    }
  } catch (error) {
    console.error('Error rejecting KYC:', error);
  }
}

async function loadFraudAlerts(status = 'new') {
  try {
    const response = await fetch(`/admin/api/security/fraud-alerts?status=${status}`, {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    const container = document.getElementById('alertsTable');
    
    if (!data.success || !data.alerts || data.alerts.length === 0) {
      container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-gray);"><h3>‚úÖ No ${status} Alerts</h3></div>`;
      return;
    }
    
    let html = `<table class="data-table"><thead><tr><th>User</th><th>Type</th><th>Severity</th><th>Description</th><th>Created</th><th>Actions</th></tr></thead><tbody>`;
    data.alerts.forEach(alert => {
      const severityClass = alert.severity === 'critical' ? 'status-rejected' : alert.severity === 'high' ? 'status-pending' : 'status-approved';
      html += `<tr><td><strong>${alert.full_name || 'N/A'}</strong><br><small>ID: ${alert.user_id}</small></td><td>${alert.alert_type || 'Unknown'}</td><td><span class="status-badge ${severityClass}">${alert.severity}</span></td><td style="max-width: 300px;">${alert.description || ''}</td><td>${new Date(alert.created_at).toLocaleDateString()}</td><td>${status !== 'resolved' ? `<button class="btn btn-primary btn-sm" onclick="showAlertResolve(${alert.id}, '${alert.alert_type}')">üîç Resolve</button>` : '‚úÖ'}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading fraud alerts:', error);
  }
}

function showAlertResolve(alertId, alertType) {
  currentAlertId = alertId;
  document.getElementById('alertResolveContent').innerHTML = `<div style="background: #fee2e2; padding: 15px; border-radius: 8px;"><p><strong>Alert Type:</strong> ${alertType}</p></div>`;
  document.getElementById('alertResolveModal').style.display = 'flex';
}

async function resolveAlert() {
  if (!currentAlertId) return;
  try {
    const resolution = document.getElementById('alertResolution').value;
    const notes = document.getElementById('alertNotes').value;
    const response = await fetch(`/admin/api/security/fraud-alerts/${currentAlertId}/resolve`, { 
      method: 'POST', 
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${sessionToken}` 
      }, 
      body: JSON.stringify({ resolution, notes }) 
    });
    const data = await response.json();
    if (data.success) {
      alert('Alert Resolved');
      closeModal('alertResolveModal');
      loadFraudAlerts('new');
      loadSecurityDashboard();
    }
  } catch (error) {
    console.error('Error resolving alert:', error);
  }
}

async function loadSharedDevices() {
  try {
    const response = await fetch('/admin/api/security/shared-devices', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    const container = document.getElementById('devicesTable');
    
    if (!data.success || !data.sharedDevices || data.sharedDevices.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-gray);"><h3>‚úÖ No Shared Devices Detected</h3></div>';
      return;
    }
    
    let html = `<table class="data-table"><thead><tr><th>Device ID</th><th>Users</th><th>Platform</th><th>First Seen</th><th>Flagged</th></tr></thead><tbody>`;
    data.sharedDevices.forEach(device => {
      html += `<tr><td><code style="font-size: 11px;">${device.device_id?.substring(0, 20)}...</code></td><td>${device.user_count || 0} users</td><td>${device.platform || 'N/A'}</td><td>${device.first_seen ? new Date(device.first_seen).toLocaleDateString() : 'N/A'}</td><td>${device.is_flagged ? 'üö© Yes' : '‚úÖ No'}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading shared devices:', error);
  }
}

async function loadHighRiskUsers() {
  try {
    const minScore = document.getElementById('anomalyScoreFilter')?.value || 70;
    const response = await fetch(`/admin/api/security/high-risk-users?minScore=${minScore}`, {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    const container = document.getElementById('behaviorTable');
    
    if (!data.success || !data.users || data.users.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-gray);"><h3>‚úÖ No High Risk Users</h3></div>';
      return;
    }
    
    let html = `<table class="data-table"><thead><tr><th>User</th><th>Score</th><th>Avg Response</th><th>Games/Day</th><th>Win Rate</th><th>Anomalies</th></tr></thead><tbody>`;
    data.users.forEach(user => {
      const scoreColor = user.anomaly_score >= 80 ? '#dc2626' : user.anomaly_score >= 60 ? '#d97706' : '#059669';
      html += `<tr><td><strong>${user.full_name || 'N/A'}</strong><br><small>ID: ${user.user_id}</small></td><td><span style="color: ${scoreColor}; font-weight: bold;">${user.anomaly_score || 0}</span></td><td>${user.avg_response_time_ms ? (user.avg_response_time_ms / 1000).toFixed(1) + 's' : 'N/A'}</td><td>${user.avg_games_per_day?.toFixed(1) || 'N/A'}</td><td>${user.win_rate ? (user.win_rate * 100).toFixed(0) + '%' : 'N/A'}</td><td style="max-width: 200px; font-size: 11px;">${user.anomalies ? user.anomalies.join(', ') : 'None'}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading high risk users:', error);
  }
}

async function loadCaptchaStats() {
  try {
    const response = await fetch('/admin/api/security/captcha-stats', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    
    if (data.success) {
      document.getElementById('totalCaptchas').textContent = data.totals?.total || 0;
      document.getElementById('passedCaptchas').textContent = data.totals?.passed || 0;
      document.getElementById('failedCaptchas').textContent = data.totals?.failed || 0;
      
      if (data.byType && data.byType.length > 0) {
        let html = `<table class="data-table"><thead><tr><th>Type</th><th>Count</th><th>Passed</th><th>Failed</th><th>Avg Time</th></tr></thead><tbody>`;
        data.byType.forEach(type => {
          html += `<tr><td>${type.captcha_type || 'Unknown'}</td><td>${type.type_count || 0}</td><td style="color: green;">${type.passed || 0}</td><td style="color: red;">${type.failed || 0}</td><td>${type.avg_response_time ? (type.avg_response_time / 1000).toFixed(2) + 's' : 'N/A'}</td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('captchaByType').innerHTML = html;
      }
    }
    loadSuspiciousCaptchaUsers();
  } catch (error) {
    console.error('Error loading CAPTCHA stats:', error);
  }
}

async function loadSuspiciousCaptchaUsers() {
  try {
    const response = await fetch('/admin/api/security/suspicious-captcha-users', {
      headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    const container = document.getElementById('suspiciousCaptchaUsers');
    
    if (!data.success || !data.users || data.users.length === 0) {
      container.innerHTML = '<p style="color: var(--text-gray);">No suspicious CAPTCHA activity detected.</p>';
      return;
    }
    
    let html = `<table class="data-table"><thead><tr><th>User</th><th>Total</th><th>Failures</th><th>Avg Time</th><th>Min Time</th></tr></thead><tbody>`;
    data.users.forEach(user => {
      html += `<tr><td><strong>${user.full_name || user.username || 'N/A'}</strong></td><td>${user.total_captchas || 0}</td><td style="color: red;">${user.failures || 0}</td><td>${user.avg_response_time ? (user.avg_response_time / 1000).toFixed(2) + 's' : 'N/A'}</td><td style="${user.min_response_time < 500 ? 'color: red; font-weight: bold;' : ''}">${user.min_response_time ? user.min_response_time + 'ms' : 'N/A'}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading suspicious CAPTCHA users:', error);
  }
}

</script>

</body>
</html>