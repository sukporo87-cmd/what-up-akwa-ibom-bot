<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>What's Up Trivia - Admin Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #667eea;
      --primary-dark: #5568d3;
      --success: #10b981;
      --success-dark: #059669;
      --danger: #ef4444;
      --danger-dark: #dc2626;
      --warning: #f59e0b;
      --secondary: #6b7280;
      --bg-gray: #f5f7fa;
      --text-dark: #333;
      --text-gray: #666;
      --text-light: #999;
      --border: #e0e0e0;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-lg: 0 4px 12px rgba(0,0,0,0.12);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-gray);
      color: var(--text-dark);
      line-height: 1.6;
    }

    #loginPage {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
      padding: 20px;
    }

    .login-container {
      background: white;
      border-radius: 20px;
      padding: 50px 40px;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }

    .login-logo { font-size: 64px; margin-bottom: 20px; }
    .login-container h1 { font-size: 28px; color: var(--text-dark); margin-bottom: 10px; }
    .login-container p { color: var(--text-gray); margin-bottom: 30px; }
    .login-form { text-align: left; }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    .login-btn:hover { background: var(--primary-dark); }
    .login-btn:disabled { background: var(--secondary); cursor: not-allowed; }

    .login-error {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .login-error.show { display: block; animation: shake 0.3s; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    #dashboardPage { display: none; }
    #dashboardPage.active { display: block; }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
      color: white;
      padding: 20px 40px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left h1 { font-size: 24px; margin-bottom: 5px; }
    .header-left p { opacity: 0.9; font-size: 14px; }

    .header-right { display: flex; gap: 15px; align-items: center; }
    .admin-info { text-align: right; margin-right: 20px; }
    .admin-info .admin-name { font-weight: 600; font-size: 14px; }
    .admin-info .session-timer { font-size: 12px; opacity: 0.8; }

    .logout-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logout-btn:hover { background: white; color: var(--primary); }

    .container { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--primary);
      transform: scaleY(0);
      transition: transform 0.3s;
    }

    .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
    .stat-card:hover::before { transform: scaleY(1); }

    .stat-card h3 {
      font-size: 14px;
      color: var(--text-gray);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value { font-size: 32px; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
    .stat-card .label { font-size: 13px; color: var(--text-light); }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 15px;
      color: var(--text-gray);
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab:hover { color: var(--primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }

    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card { background: white; border-radius: 12px; padding: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
      flex-wrap: wrap;
      gap: 15px;
    }

    .card-header h2 { font-size: 20px; color: var(--text-dark); }
    .card-header h3 { font-size: 18px; color: var(--text-dark); margin-bottom: 15px; }

    .filter-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    .filter-group select, .filter-group input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .filter-group select:focus, .filter-group input:focus { outline: none; border-color: var(--primary); }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover:not(:disabled) { background: var(--success-dark); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover:not(:disabled) { background: var(--danger-dark); }
    .btn-secondary { background: var(--secondary); color: white; }
    .btn-secondary:hover:not(:disabled) { background: #4b5563; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-warning:hover:not(:disabled) { background: #d97706; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }

    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead { background: #f9fafb; }

    th {
      text-align: left;
      padding: 12px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border);
    }

    td { padding: 15px 12px; border-bottom: 1px solid #f0f0f0; }
    tr:hover { background: #f9fafb; }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-pending { background: #fef3c7; color: #92400e; }
    .status-details_collected { background: #dbeafe; color: #1e40af; }
    .status-approved { background: #d1fae5; color: #065f46; }
    .status-paid { background: #d1fae5; color: #065f46; }
    .status-confirmed { background: #e0e7ff; color: #3730a3; }

    .verified-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: #d1fae5;
      color: #065f46;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .unverified-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: #fee2e2;
      color: #991b1b;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .empty-state .icon { font-size: 64px; opacity: 0.3; margin-bottom: 15px; }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .modal.show { display: flex; animation: fadeIn 0.2s; }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-header h3 { font-size: 20px; }

    .close-modal {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--text-light);
      transition: color 0.3s, transform 0.3s;
    }

    .close-modal:hover { color: var(--danger); transform: rotate(90deg); }

    .form-group { margin-bottom: 20px; }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #555;
    }

    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-group textarea { resize: vertical; min-height: 80px; font-family: inherit; }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-row:last-child { border-bottom: none; }
    .detail-label { font-weight: 500; color: var(--text-gray); }
    .detail-value { color: var(--text-dark); font-weight: 500; }

    .loading { text-align: center; padding: 40px; color: var(--text-light); }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      animation: slideDown 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .alert-success { background: #d1fae5; color: #065f46; border: 1px solid var(--success); }
    .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid var(--danger); }
    .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }

    .chart-container { position: relative; height: 300px; margin: 20px 0; }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .top-performers-table { width: 100%; margin-top: 20px; }
    .top-performers-table td { padding: 12px; }
    .medal { font-size: 24px; margin-right: 8px; }

    @media (max-width: 768px) {
      .header { padding: 15px 20px; flex-direction: column; gap: 15px; }
      .header-right { width: 100%; justify-content: space-between; }
      .container { padding: 20px 15px; }
      .stats-grid { grid-template-columns: 1fr; }
      .card-header { flex-direction: column; align-items: flex-start; }
      .filter-group { width: 100%; }
      table { font-size: 12px; }
      th, td { padding: 8px; }
      .btn { padding: 8px 16px; font-size: 13px; }
      .chart-grid { grid-template-columns: 1fr; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <div class="login-container">
    <div class="login-logo">üéÆ</div>
    <h1>Admin Dashboard</h1>
    <p>What's Up Trivia - Akwa Ibom Edition</p>
    <div class="login-error" id="loginError"></div>
    <form class="login-form" id="loginForm">
      <div class="form-group">
        <label>Admin Access Token</label>
        <input type="password" id="adminToken" placeholder="Enter admin token" required autofocus>
      </div>
      <button type="submit" class="login-btn" id="loginBtn">üîê Sign In</button>
    </form>
    <p style="margin-top: 20px; font-size: 12px; color: #999;">
      Secure access only ‚Ä¢ All activity is logged
    </p>
  </div>
</div>

<!-- PART 1 ENDS HERE - CONTINUE TO PART 2 -->
 <!-- PART 2 STARTS HERE - THIS GOES AFTER PART 1 -->

<!-- MAIN DASHBOARD -->
<div id="dashboardPage">
  <div class="header">
    <div class="header-left">
      <h1>üéÆ What's Up Trivia - Admin Dashboard</h1>
      <p>Akwa Ibom Edition</p>
    </div>
    <div class="header-right">
      <div class="admin-info">
        <div class="admin-name">üë§ Admin</div>
        <div class="session-timer" id="sessionTimer">Session active</div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <span>üö™</span>
        <span>Logout</span>
      </button>
    </div>
  </div>

  <div class="container">
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3>Pending Payouts</h3>
        <div class="value" id="pendingCount">-</div>
        <div class="label" id="pendingAmount">Loading...</div>
      </div>
      <div class="stat-card">
        <h3>Paid Today</h3>
        <div class="value" id="paidCount">-</div>
        <div class="label" id="paidAmount">Loading...</div>
      </div>
      <div class="stat-card">
        <h3>Total Users</h3>
        <div class="value" id="totalUsers">-</div>
        <div class="label">Registered players</div>
      </div>
      <div class="stat-card">
        <h3>Total Questions</h3>
        <div class="value" id="totalQuestions">-</div>
        <div class="label">Active questions</div>
      </div>
    </div>

    <div id="alertContainer"></div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('analytics')">üìä Analytics</button>
      <button class="tab" onclick="switchTab('payouts')">üí∞ Payouts</button>
      <button class="tab" onclick="switchTab('history')">üìú History</button>
      <button class="tab" onclick="switchTab('users')">üë• Users</button>
      <button class="tab" onclick="switchTab('questions')">‚ùì Questions</button>
      <button class="tab" onclick="switchTab('activity')">üìã Activity Log</button>
    </div>

    <!-- Analytics Tab -->
    <div id="analyticsTab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2>üìä Analytics Dashboard</h2>
          <button class="btn btn-primary" onclick="loadAnalytics()">üîÑ Refresh</button>
        </div>
        <div id="analyticsContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading analytics...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Payouts Tab -->
    <div id="payoutsTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Pending Payouts</h2>
          <div class="filter-group">
            <select id="statusFilter" onchange="filterPayouts()">
              <option value="">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="details_collected">Details Collected</option>
              <option value="approved">Approved</option>
              <option value="paid">Paid</option>
            </select>
            <button class="btn btn-primary" onclick="loadPayouts()">üîÑ Refresh</button>
          </div>
        </div>
        <div id="payoutsTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading payouts...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div id="historyTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Payout History</h2>
          <div class="filter-group">
            <select id="periodFilter" onchange="loadHistory()">
              <option value="all">All Time</option>
              <option value="daily">Today</option>
              <option value="weekly">This Week</option>
              <option value="monthly">This Month</option>
            </select>
            <button class="btn btn-primary" onclick="loadHistory()">üîÑ Refresh</button>
          </div>
        </div>
        <div id="historyTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading history...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="usersTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>All Users</h2>
          <div class="filter-group">
            <button class="btn btn-primary" onclick="loadUsers()">üîÑ Refresh</button>
          </div>
        </div>
        <div id="usersTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading users...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Questions Tab -->
    <div id="questionsTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Questions Bank</h2>
          <div class="filter-group">
            <select id="difficultyFilter" onchange="loadQuestions()">
              <option value="">All Difficulties</option>
              <option value="1-5">Easy (1-5)</option>
              <option value="6-10">Medium (6-10)</option>
              <option value="11-15">Hard (11-15)</option>
            </select>
            <button class="btn btn-success" onclick="showAddQuestionModal()">+ Add Question</button>
          </div>
        </div>
        <div id="questionsTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading questions...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity Log Tab -->
    <div id="activityTab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Admin Activity Log</h2>
          <div class="filter-group">
            <button class="btn btn-primary" onclick="loadActivityLog()">üîÑ Refresh</button>
          </div>
        </div>
        <div id="activityTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading activity log...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mark as Paid Modal -->
<div id="markPaidModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üíµ Mark as Paid</h3>
      <button class="close-modal" onclick="closeModal('markPaidModal')">&times;</button>
    </div>
    <div id="payoutDetails"></div>
    <form id="markPaidForm" onsubmit="submitMarkPaid(event)">
      <div class="form-group">
        <label>Payment Reference *</label>
        <input type="text" id="paymentReference" required placeholder="e.g., GTB/20241208/12345">
      </div>
      <div class="form-group">
        <label>Payment Method</label>
        <select id="paymentMethod">
          <option value="bank_transfer">Bank Transfer</option>
          <option value="mobile_money">Mobile Money</option>
          <option value="ussd">USSD</option>
          <option value="other">Other</option>
        </select>
      </div>
      <input type="hidden" id="selectedTransactionId">
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button type="submit" class="btn btn-success" style="flex: 1;">‚úì Confirm Payment</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('markPaidModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Question Modal -->
<div id="addQuestionModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚ûï Add New Question</h3>
      <button class="close-modal" onclick="closeModal('addQuestionModal')">&times;</button>
    </div>
    <form id="addQuestionForm" onsubmit="submitAddQuestion(event)">
      <div class="form-group">
        <label>Question Text *</label>
        <textarea id="questionText" required placeholder="What is the capital of Akwa Ibom State?"></textarea>
      </div>
      <div class="form-group">
        <label>Option A *</label>
        <input type="text" id="optionA" required placeholder="First option">
      </div>
      <div class="form-group">
        <label>Option B *</label>
        <input type="text" id="optionB" required placeholder="Second option">
      </div>
      <div class="form-group">
        <label>Option C *</label>
        <input type="text" id="optionC" required placeholder="Third option">
      </div>
      <div class="form-group">
        <label>Option D *</label>
        <input type="text" id="optionD" required placeholder="Fourth option">
      </div>
      <div class="form-group">
        <label>Correct Answer *</label>
        <select id="correctAnswer" required>
          <option value="">Select correct answer</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
        </select>
      </div>
      <div class="form-group">
        <label>Difficulty Level (1-15) *</label>
        <input type="number" id="difficulty" required min="1" max="15" placeholder="1 = Easiest, 15 = Hardest">
      </div>
      <div class="form-group">
        <label>Category</label>
        <input type="text" id="category" placeholder="e.g., History, Geography, Culture">
      </div>
      <div class="form-group">
        <label>Fun Fact (Optional)</label>
        <textarea id="funFact" placeholder="Interesting fact related to the answer"></textarea>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button type="submit" class="btn btn-success" style="flex: 1;">‚úì Add Question</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('addQuestionModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- PART 2 ENDS HERE - CONTINUE TO PART 3 -->
 <!-- PART 3 STARTS HERE - THIS GOES AFTER PART 2 -->

<script>
// State
let sessionToken = null;
let sessionExpiry = null;
let allUsers = [];
let charts = {};

// Initialize
checkSession();

// AUTHENTICATION
function checkSession() {
  sessionToken = localStorage.getItem('adminSessionToken');
  sessionExpiry = localStorage.getItem('adminSessionExpiry');
  if (sessionToken && sessionExpiry) {
    const now = new Date().getTime();
    const expiry = new Date(sessionExpiry).getTime();
    if (now < expiry) {
      showDashboard();
      startSessionTimer();
      return;
    }
  }
  showLogin();
}

function showLogin() {
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('dashboardPage').classList.remove('active');
}

function showDashboard() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('dashboardPage').classList.add('active');
  loadStats();
  loadAnalytics();
}

document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const token = document.getElementById('adminToken').value;
  const loginBtn = document.getElementById('loginBtn');
  const errorDiv = document.getElementById('loginError');
  loginBtn.disabled = true;
  loginBtn.textContent = 'üîÑ Signing in...';
  errorDiv.classList.remove('show');
  try {
    const response = await fetch('/admin/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token })
    });
    const result = await response.json();
    if (result.success) {
      sessionToken = result.sessionToken;
      sessionExpiry = result.expiresAt;
      localStorage.setItem('adminSessionToken', sessionToken);
      localStorage.setItem('adminSessionExpiry', sessionExpiry);
      showDashboard();
      startSessionTimer();
    } else {
      errorDiv.textContent = '‚ùå ' + (result.error || 'Invalid token');
      errorDiv.classList.add('show');
    }
  } catch (error) {
    errorDiv.textContent = '‚ùå Login failed. Please try again.';
    errorDiv.classList.add('show');
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'üîê Sign In';
  }
});

async function logout() {
  if (!confirm('Are you sure you want to logout?')) return;
  try {
    await fetch('/admin/api/logout', {
      method: 'POST',
      headers: getAuthHeaders()
    });
  } catch (error) {
    console.error('Logout error:', error);
  }
  localStorage.removeItem('adminSessionToken');
  localStorage.removeItem('adminSessionExpiry');
  sessionToken = null;
  sessionExpiry = null;
  showLogin();
}

function startSessionTimer() {
  updateSessionTimer();
  setInterval(updateSessionTimer, 60000);
}

function updateSessionTimer() {
  if (!sessionExpiry) return;
  const now = new Date().getTime();
  const expiry = new Date(sessionExpiry).getTime();
  const remaining = expiry - now;
  if (remaining <= 0) {
    showAlert('Session expired. Please login again.', 'error');
    logout();
    return;
  }
  const hours = Math.floor(remaining / (1000 * 60 * 60));
  const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
  document.getElementById('sessionTimer').textContent = `Session expires in ${hours}h ${minutes}m`;
}

function getAuthHeaders() {
  return {
    'Authorization': `Bearer ${sessionToken}`,
    'Content-Type': 'application/json'
  };
}

// STATS
async function loadStats() {
  try {
    const response = await fetch('/admin/api/stats', { headers: getAuthHeaders() });
    const stats = await response.json();
    document.getElementById('pendingCount').textContent = stats.pending_count || 0;
    document.getElementById('pendingAmount').textContent = `‚Ç¶${(parseFloat(stats.pending_amount) || 0).toLocaleString()}`;
    document.getElementById('paidCount').textContent = stats.paid_today_count || 0;
    document.getElementById('paidAmount').textContent = `‚Ç¶${(parseFloat(stats.paid_today_amount) || 0).toLocaleString()}`;
    document.getElementById('totalUsers').textContent = stats.total_users || 0;
    document.getElementById('totalQuestions').textContent = stats.total_questions || 0;
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

// ANALYTICS
async function loadAnalytics() {
  const container = document.getElementById('analyticsContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading analytics...</p></div>';
  try {
    const response = await fetch('/admin/api/analytics', { headers: getAuthHeaders() });
    const data = await response.json();
    Object.values(charts).forEach(chart => { if (chart && typeof chart.destroy === 'function') chart.destroy(); });
    charts = {};
    let html = `
      <div class="chart-grid">
        <div class="card"><h3>üìà Daily Games Played (Last 14 Days)</h3><div class="chart-container"><canvas id="dailyGamesChart"></canvas></div></div>
        <div class="card"><h3>üí∞ Prize Distribution by Difficulty</h3><div class="chart-container"><canvas id="prizeDistChart"></canvas></div></div>
      </div>
      <div class="chart-grid">
        <div class="card"><h3>üë• User Registration Trend (Last 30 Days)</h3><div class="chart-container"><canvas id="regTrendChart"></canvas></div></div>
        <div class="card"><h3>üìä Question Performance by Difficulty</h3><div class="chart-container"><canvas id="questionPerfChart"></canvas></div></div>
      </div>
      <div class="chart-grid">
        <div class="card"><h3>üéØ Payout Status Breakdown</h3><div class="chart-container"><canvas id="payoutStatusChart"></canvas></div></div>
        <div class="card"><h3>üèÜ Top Performers</h3><table class="top-performers-table"><thead><tr><th>Rank</th><th>Player</th><th>LGA</th><th>Games</th><th>Winnings</th></tr></thead><tbody id="topPerformersBody"></tbody></table></div>
      </div>
    `;
    container.innerHTML = html;
    setTimeout(() => {
      renderDailyGamesChart(data.dailyGames);
      renderPrizeDistChart(data.prizeDistribution);
      renderRegTrendChart(data.registrationTrend);
      renderQuestionPerfChart(data.questionPerformance);
      renderPayoutStatusChart(data.payoutBreakdown);
      renderTopPerformers(data.topPerformers);
    }, 100);
  } catch (error) {
    console.error('Error loading analytics:', error);
    container.innerHTML = '<div class="empty-state"><p>Error loading analytics</p></div>';
  }
}

function renderDailyGamesChart(data) {
  const ctx = document.getElementById('dailyGamesChart');
  if (!ctx) return;
  const labels = data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
  const values = data.map(d => parseInt(d.games_count));
  charts.dailyGames = new Chart(ctx, {
    type: 'line',
    data: { labels: labels, datasets: [{ label: 'Games Played', data: values, borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', fill: true, tension: 0.4 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
}

function renderPrizeDistChart(data) {
  const ctx = document.getElementById('prizeDistChart');
  if (!ctx) return;
  const labels = data.map(d => d.difficulty_range);
  const values = data.map(d => parseFloat(d.total_amount));
  charts.prizeDist = new Chart(ctx, {
    type: 'bar',
    data: { labels: labels, datasets: [{ label: 'Total Winnings', data: values, backgroundColor: ['#10b981', '#f59e0b', '#ef4444'] }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return '‚Ç¶' + value.toLocaleString(); } } } } }
  });
}

function renderRegTrendChart(data) {
  const ctx = document.getElementById('regTrendChart');
  if (!ctx) return;
  const labels = data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
  const values = data.map(d => parseInt(d.new_users));
  charts.regTrend = new Chart(ctx, {
    type: 'line',
    data: { labels: labels, datasets: [{ label: 'New Users', data: values, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
}

function renderQuestionPerfChart(data) {
  const ctx = document.getElementById('questionPerfChart');
  if (!ctx) return;
  const grouped = {};
  data.forEach(q => {
    let range;
    if (q.difficulty >= 1 && q.difficulty <= 5) range = 'Q1-Q5';
    else if (q.difficulty >= 6 && q.difficulty <= 10) range = 'Q6-Q10';
    else range = 'Q11-Q15';
    if (!grouped[range]) grouped[range] = { total: 0, count: 0 };
    grouped[range].total += parseFloat(q.success_rate);
    grouped[range].count++;
  });
  const labels = Object.keys(grouped);
  const values = labels.map(l => (grouped[l].total / grouped[l].count).toFixed(1));
  const colors = values.map(v => { if (v >= 80) return '#10b981'; if (v >= 60) return '#f59e0b'; return '#ef4444'; });
  charts.questionPerf = new Chart(ctx, {
    type: 'bar',
    data: { labels: labels, datasets: [{ label: 'Success Rate (%)', data: values, backgroundColor: colors }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: function(value) { return value + '%'; } } } } }
  });
}

function renderPayoutStatusChart(data) {
  const ctx = document.getElementById('payoutStatusChart');
  if (!ctx) return;
  const labels = data.map(d => {
    const statusNames = { 'pending': 'Pending', 'details_collected': 'Details Collected', 'approved': 'Approved', 'paid': 'Paid', 'confirmed': 'Confirmed' };
    return statusNames[d.payout_status] || d.payout_status;
  });
  const values = data.map(d => parseInt(d.count));
  charts.payoutStatus = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: labels, datasets: [{ data: values, backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#059669', '#6366f1'] }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });
}

function renderTopPerformers(data) {
  const tbody = document.getElementById('topPerformersBody');
  if (!tbody) return;
  if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No data yet</td></tr>'; return; }
  const medals = ['ü•á', 'ü•à', 'ü•â'];
  tbody.innerHTML = data.map((player, index) => `<tr><td>${index < 3 ? `<span class="medal">${medals[index]}</span>` : ''}#${index + 1}</td><td><strong>${player.full_name}</strong></td><td>${player.lga}</td><td>${player.total_games_played}</td><td><strong>‚Ç¶${parseFloat(player.total_winnings).toLocaleString()}</strong></td></tr>`).join('');
}

// PAYOUTS
async function loadPayouts() {
  const container = document.getElementById('payoutsTableContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading payouts...</p></div>';
  try {
    const status = document.getElementById('statusFilter')?.value || '';
    const url = status ? `/admin/api/payouts/pending?status=${status}` : '/admin/api/payouts/pending';
    const response = await fetch(url, { headers: getAuthHeaders() });
    const payouts = await response.json();
    if (payouts.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No pending payouts</p></div>'; return; }
    let html = '<table><thead><tr><th>ID</th><th>Winner</th><th>Amount</th><th>Status</th><th>Bank Details</th><th>Verification</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
    payouts.forEach(payout => {
      const hasDetails = payout.account_name ? '‚úÖ' : '‚è≥';
      const detailsText = payout.account_name ? `${payout.account_name}<br><small>${payout.bank_name} - ${payout.account_number}</small>` : 'Awaiting details';
      const verificationBadge = payout.verified ? '<span class="verified-badge">‚úì Verified</span>' : payout.account_name ? '<span class="unverified-badge">‚ö† Not Verified</span>' : '-';
      html += `<tr><td>#${payout.transaction_id}</td><td><strong>${payout.full_name}</strong><br><small style="color: #999;">${payout.phone_number}</small></td><td><strong>‚Ç¶${parseFloat(payout.amount).toLocaleString()}</strong></td><td><span class="status-badge status-${payout.payout_status}">${payout.payout_status}</span></td><td>${hasDetails} <small>${detailsText}</small></td><td>${verificationBadge}</td><td>${new Date(payout.win_date).toLocaleDateString()}</td><td>${payout.account_name ? `<div style="display: flex; gap: 5px; flex-wrap: wrap;"><button class="btn btn-success btn-sm" onclick="showMarkPaidModal(${payout.transaction_id})">üíµ Mark Paid</button>${!payout.verified ? `<button class="btn btn-warning btn-sm" onclick="reverifyPayout(${payout.transaction_id})">üîÑ Re-verify</button>` : ''}</div>` : `<button class="btn btn-secondary btn-sm" disabled>‚è≥ Waiting</button>`}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading payouts:', error);
    container.innerHTML = '<div class="empty-state"><p>Error loading payouts</p></div>';
  }
}

function filterPayouts() { loadPayouts(); }

async function reverifyPayout(transactionId) {
  if (!confirm('Re-verify this bank account with Paystack?')) return;
  try {
    const response = await fetch(`/admin/api/payouts/${transactionId}/reverify`, { method: 'POST', headers: getAuthHeaders() });
    const result = await response.json();
    if (result.success) { showAlert(`‚úÖ Account verified: ${result.accountName}`, 'success'); loadPayouts(); } else { showAlert(`‚ùå Verification failed: ${result.error}`, 'error'); }
  } catch (error) { showAlert('‚ùå Error re-verifying account', 'error'); }
}

async function showMarkPaidModal(transactionId) {
  document.getElementById('selectedTransactionId').value = transactionId;
  try {
    const response = await fetch(`/admin/api/payouts/${transactionId}`, { headers: getAuthHeaders() });
    const payout = await response.json();
    const verificationBadge = payout.verified ? '<span class="verified-badge">‚úì Verified by Paystack</span>' : '<span class="unverified-badge">‚ö† Not Verified</span>';
    document.getElementById('payoutDetails').innerHTML = `<div style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;"><div class="detail-row"><span class="detail-label">Winner:</span><span class="detail-value">${payout.full_name}</span></div><div class="detail-row"><span class="detail-label">Amount:</span><span class="detail-value">‚Ç¶${parseFloat(payout.amount).toLocaleString()}</span></div><div class="detail-row"><span class="detail-label">Account Name:</span><span class="detail-value">${payout.account_name}</span></div><div class="detail-row"><span class="detail-label">Account Number:</span><span class="detail-value">${payout.account_number}</span></div><div class="detail-row"><span class="detail-label">Bank:</span><span class="detail-value">${payout.bank_name}</span></div><div class="detail-row"><span class="detail-label">Verification Status:</span><span class="detail-value">${verificationBadge}</span></div></div>`;
    document.getElementById('markPaidModal').classList.add('show');
  } catch (error) { showAlert('Error loading payout details', 'error'); }
}

async function submitMarkPaid(event) {
  event.preventDefault();
  const transactionId = document.getElementById('selectedTransactionId').value;
  const paymentReference = document.getElementById('paymentReference').value;
  const paymentMethod = document.getElementById('paymentMethod').value;
  try {
    const response = await fetch(`/admin/api/payouts/${transactionId}/mark-paid`, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ paymentReference, paymentMethod }) });
    const result = await response.json();
    if (result.success) { showAlert('‚úÖ Payment marked as paid! Winner notified via WhatsApp.', 'success'); closeModal('markPaidModal'); loadStats(); loadPayouts(); document.getElementById('markPaidForm').reset(); } else { showAlert('‚ùå Error marking payment as paid', 'error'); }
  } catch (error) { showAlert('‚ùå Error processing request', 'error'); }
}

// HISTORY
async function loadHistory() {
  const container = document.getElementById('historyTableContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading history...</p></div>';
  try {
    const period = document.getElementById('periodFilter')?.value || 'all';
    const response = await fetch(`/admin/api/payouts/history?period=${period}`, { headers: getAuthHeaders() });
    const data = await response.json();
    if (data.payouts.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No payout history found</p></div>'; return; }
    let html = '<table><thead><tr><th>ID</th><th>Winner</th><th>Amount</th><th>Bank Details</th><th>Reference</th><th>Paid Date</th><th>Status</th></tr></thead><tbody>';
    data.payouts.forEach(payout => { html += `<tr><td>#${payout.transaction_id}</td><td><strong>${payout.full_name}</strong><br><small style="color: #999;">${payout.phone_number}</small></td><td><strong>‚Ç¶${parseFloat(payout.amount).toLocaleString()}</strong></td><td><small>${payout.account_name || 'N/A'}<br>${payout.bank_name || 'N/A'}</small></td><td><small>${payout.payment_reference || 'N/A'}</small></td><td>${payout.paid_at ? new Date(payout.paid_at).toLocaleDateString() : 'N/A'}</td><td><span class="status-badge status-${payout.payout_status}">${payout.payout_status}</span></td></tr>`; });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) { console.error('Error loading history:', error); container.innerHTML = '<div class="empty-state"><p>Error loading history</p></div>'; }
}

// USERS
async function loadUsers() {
  const container = document.getElementById('usersTableContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading users...</p></div>';
  try {
    const response = await fetch('/admin/api/users', { headers: getAuthHeaders() });
    const data = await response.json();
    allUsers = data.users;
    if (allUsers.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">üë•</div><p>No users found</p></div>'; return; }
    let html = '<table><thead><tr><th>Name</th><th>Phone</th><th>LGA</th><th>Games</th><th>Winnings</th><th>Remaining</th><th>Joined</th></tr></thead><tbody>';
    allUsers.forEach(user => { html += `<tr><td><strong>${user.full_name}</strong></td><td>${user.phone_number}</td><td>${user.lga}</td><td>${user.total_games_played}</td><td>‚Ç¶${parseFloat(user.total_winnings).toLocaleString()}</td><td>${user.games_remaining || 0}</td><td>${new Date(user.created_at).toLocaleDateString()}</td></tr>`; });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) { container.innerHTML = '<div class="empty-state"><p>Error loading users</p></div>'; }
}

// QUESTIONS
async function loadQuestions() {
  const container = document.getElementById('questionsTableContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading questions...</p></div>';
  try {
    const response = await fetch('/admin/api/questions', { headers: getAuthHeaders() });
    const data = await response.json();
    if (data.questions.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">‚ùì</div><p>No questions found</p></div>'; return; }
    let html = '<table><thead><tr><th>ID</th><th>Question</th><th>Difficulty</th><th>Category</th><th>Answer</th><th>Status</th></tr></thead><tbody>';
    data.questions.forEach(q => { html += `<tr><td>${q.id}</td><td>${q.question_text.substring(0, 80)}${q.question_text.length > 80 ? '...' : ''}</td><td>Q${q.difficulty}</td><td>${q.category}</td><td><strong>${q.correct_answer}</strong></td><td><span class="status-badge ${q.is_active ? 'status-approved' : 'status-pending'}">${q.is_active ? 'Active' : 'Inactive'}</span></td></tr>`; });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) { container.innerHTML = '<div class="empty-state"><p>Error loading questions</p></div>'; }
}

function showAddQuestionModal() { document.getElementById('addQuestionModal').classList.add('show'); }

async function submitAddQuestion(event) {
  event.preventDefault();
  const questionData = {
    question_text: document.getElementById('questionText').value,
    option_a: document.getElementById('optionA').value,
    option_b: document.getElementById('optionB').value,
    option_c: document.getElementById('optionC').value,
    option_d: document.getElementById('optionD').value,
    correct_answer: document.getElementById('correctAnswer').value,
    difficulty: parseInt(document.getElementById('difficulty').value),
    category: document.getElementById('category').value || 'General',
    fun_fact: document.getElementById('funFact').value || null
  };
  try {
    const response = await fetch('/admin/api/questions', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(questionData) });
    const result = await response.json();
    if (result.success) { showAlert('‚úÖ Question added successfully!', 'success'); closeModal('addQuestionModal'); loadQuestions(); loadStats(); document.getElementById('addQuestionForm').reset(); } else { showAlert('‚ùå ' + (result.error || 'Error adding question'), 'error'); }
  } catch (error) { showAlert('‚ùå Error adding question', 'error'); }
}

// ACTIVITY LOG
async function loadActivityLog() {
  const container = document.getElementById('activityTableContainer');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading activity log...</p></div>';
  try {
    const response = await fetch('/admin/api/activity-log', { headers: getAuthHeaders() });
    const data = await response.json();
    if (data.activities.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><p>No activity logged</p></div>'; return; }
    let html = '<table><thead><tr><th>Timestamp</th><th>Action</th><th>Details</th><th>IP Address</th></tr></thead><tbody>';
    data.activities.forEach(activity => {
      const actionIcon = { 'login': 'üîê', 'logout': 'üö™', 'view_stats': 'üìä', 'view_payouts': 'üí∞', 'approve_payout': '‚úÖ', 'mark_paid': 'üíµ', 'reverify_payout': 'üîÑ', 'add_question': '‚ûï', 'update_question': '‚úèÔ∏è', 'delete_question': 'üóëÔ∏è', 'view_analytics': 'üìà' }[activity.action_type] || 'üìù';
      html += `<tr><td>${new Date(activity.created_at).toLocaleString()}</td><td>${actionIcon} ${activity.action_type}</td><td><small>${JSON.stringify(activity.action_details || {})}</small></td><td><small>${activity.ip_address || 'N/A'}</small></td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) { container.innerHTML = '<div class="empty-state"><p>Error loading activity log</p></div>'; }
}

// UTILITIES
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(`${tab}Tab`).classList.add('active');
  if (tab === 'analytics' && !charts.dailyGames) loadAnalytics();
  if (tab === 'payouts') loadPayouts();
  if (tab === 'users' && allUsers.length === 0) loadUsers();
  if (tab === 'questions' && !document.getElementById('questionsTableContainer').innerHTML.includes('table')) loadQuestions();
  if (tab === 'history' && !document.getElementById('historyTableContainer').innerHTML.includes('table')) loadHistory();
  if (tab === 'activity' && !document.getElementById('activityTableContainer').innerHTML.includes('table')) loadActivityLog();
}

function closeModal(modalId) { document.getElementById(modalId).classList.remove('show'); }

function showAlert(message, type) {
  const container = document.getElementById('alertContainer');
  const alert = document.createElement('div');
  alert.className = `alert alert-${type}`;
  const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
  alert.innerHTML = `<span>${icon}</span><span>${message}</span>`;
  container.appendChild(alert);
  setTimeout(() => { alert.style.animation = 'fadeOut 0.3s'; setTimeout(() => alert.remove(), 300); }, 5000);
}

// Auto-refresh stats every 30 seconds
setInterval(() => { if (sessionToken) loadStats(); }, 30000);
</script>

</body>
</html>

<!-- PART 3 ENDS HERE - FILE IS NOW COMPLETE -->